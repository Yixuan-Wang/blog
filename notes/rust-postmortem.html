<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon.svg" type="image/svg+xml"><link rel="apple-touch-icon" href="/pwa-192x192.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#00aba9"><meta name="msapplication-TileColor" content="#00aba9"><meta name="theme-color" content="#ffffff"><script type="module" async="" crossorigin="" src="/assets/app.926e3245.js"></script><style>button[data-v-adef6890]{padding:.25rem;font-size:1.125rem;line-height:1.75rem;color:var(--color-accent)}button[data-v-adef6890]:hover{color:var(--color-secondary)}#app{display:grid;grid-template-rows:auto 1fr auto;grid-template-columns:100%;margin-left:1rem;margin-right:1rem;height:100%}@media (min-width:1024px){#app{margin-left:0;margin-right:0}}*,:after,:before{box-sizing:border-box;border-width:0;border-style:solid;border-color:currentColor}html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji"}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}h1,h2{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}strong{font-weight:bolder}code,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-size:1em}button{font-family:inherit;font-size:100%;line-height:inherit;color:inherit;margin:0;padding:0}button{text-transform:none}button{-webkit-appearance:button;background-color:transparent;background-image:none}h1,h2,hr,p,pre{margin:0}ul{list-style:none;margin:0;padding:0}button{cursor:pointer}*,::after,::before{--un-rotate:0;--un-rotate-x:0;--un-rotate-y:0;--un-rotate-z:0;--un-scale-x:1;--un-scale-y:1;--un-scale-z:1;--un-skew-x:0;--un-skew-y:0;--un-translate-x:0;--un-translate-y:0;--un-translate-z:0;--un-scroll-snap-strictness:proximity;--un-border-spacing-x:0;--un-border-spacing-y:0;--un-ring-offset-shadow:0 0 rgba(0,0,0,0);--un-ring-shadow:0 0 rgba(0,0,0,0);--un-shadow:0 0 rgba(0,0,0,0);--un-ring-offset-width:0px;--un-ring-offset-color:#fff;--un-ring-width:0px;--un-ring-color:rgba(147,197,253,0.5)}[i-mdi-file=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg preserveAspectRatio='xMidYMid meet' viewBox='0 0 24 24' display='inline-block' vertical-align='sub' width='1.25em' height='1.25em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M13 9V3.5L18.5 9M6 2c-1.11 0-2 .89-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6H6Z'/%3E%3C/svg%3E");mask:var(--un-icon) no-repeat;mask-size:100% 100%;-webkit-mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;background-color:currentColor;display:inline-block;vertical-align:sub;width:1.25em;height:1.25em}.i-mdi-folder,[i-mdi-folder=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg preserveAspectRatio='xMidYMid meet' viewBox='0 0 24 24' display='inline-block' vertical-align='sub' width='1.25em' height='1.25em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M10 4H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-8l-2-2Z'/%3E%3C/svg%3E");mask:var(--un-icon) no-repeat;mask-size:100% 100%;-webkit-mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;background-color:currentColor;display:inline-block;vertical-align:sub;width:1.25em;height:1.25em}[i-mdi-table-large=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg preserveAspectRatio='xMidYMid meet' viewBox='0 0 24 24' display='inline-block' vertical-align='sub' width='1.25em' height='1.25em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M4 3h16a2 2 0 0 1 2 2v15a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2m0 4v3h4V7H4m6 0v3h4V7h-4m10 3V7h-4v3h4M4 12v3h4v-3H4m0 8h4v-3H4v3m6-8v3h4v-3h-4m0 8h4v-3h-4v3m10 0v-3h-4v3h4m0-8h-4v3h4v-3Z'/%3E%3C/svg%3E");mask:var(--un-icon) no-repeat;mask-size:100% 100%;-webkit-mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;background-color:currentColor;display:inline-block;vertical-align:sub;width:1.25em;height:1.25em}[i-mdi-text-box=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg preserveAspectRatio='xMidYMid meet' viewBox='0 0 24 24' display='inline-block' vertical-align='sub' width='1.25em' height='1.25em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M14 17H7v-2h7m3-2H7v-2h10m0-2H7V7h10m2-4H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2Z'/%3E%3C/svg%3E");mask:var(--un-icon) no-repeat;mask-size:100% 100%;-webkit-mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;background-color:currentColor;display:inline-block;vertical-align:sub;width:1.25em;height:1.25em}[btn-icon=""]:hover{color:var(--color-accent);transition-duration:.3s;transition-timing-function:cubic-bezier(0,0,.2,1)}.transition-lively,[btn-icon=""],[transition-lively=""]{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:150ms;transition-duration:.2s;transition-timing-function:cubic-bezier(.4,0,1,1)}.transition-lively:hover,[transition-lively=""]:hover{transition-duration:.3s;transition-timing-function:cubic-bezier(0,0,.2,1)}.my-4{margin-top:1rem;margin-bottom:1rem}.mb-8{margin-bottom:2rem}.mt-4{margin-top:1rem}.inline-block{display:inline-block}.flex{display:flex}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-center{align-items:center}.justify-start{justify-content:flex-start}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{grid-gap:.25rem;gap:.25rem}.gap-2{grid-gap:.5rem;gap:.5rem}.gap-3{grid-gap:.75rem;gap:.75rem}.gap-x-1{grid-column-gap:.25rem;column-gap:.25rem}.gap-y-0\.5{grid-row-gap:.125rem;row-gap:.125rem}.rounded{border-radius:.25rem}.hover\:bg-acc:hover,[bg~=acc]{background-color:var(--color-accent)}.hover\:bg-sec:hover,[bg~="hover\:sec"]:hover{background-color:var(--color-secondary)}.p-1{padding:.25rem}.px-2{padding-left:.5rem;padding-right:.5rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.text-left{text-align:left}.font-mono,[font~=mono]{font-family:var(--font-mono)}.text-xs{font-size:.75rem;line-height:1rem}.font-bold,[font~=bold]{font-weight:700}.text-acc{color:var(--color-accent)}.hover\:text-bgd:hover,[text~=bgd]{color:var(--color-background)}.hover\:text-sec:hover,.text-sec{color:var(--color-secondary)}[color~="\#00aba9"]{--un-text-opacity:1;color:rgba(0,171,169,var(--un-text-opacity))}:root{--font-sans:"Noto Sans",var(--custom-font-sans, sans-serif),"SF Pro",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Avenir Next","Helvetica Neue",sans-serif;--font-serif:"Noto Serif",var(--custom-font-serif, serif),"Noto Serif","New York","Roboto Slab",Cambria,Georgia,Times,"Times New Roman",serif;--font-mono:"JetBrains Mono","SF Mono","Roboto Mono",Menlo,"Cascadia Code",Consolas,monospace}html:not(.dark){--color-accent:var(--accent-light-accent, #003A70);--color-secondary:var(--accent-light-secondary, #61649f);--color-background:#F5F5F5;--color-foreground:#1D252D;--color-dim:#737C7B}html{height:100%;width:100%;margin:0;padding:0;text-align:center;font-size:1rem;line-height:1.5rem;overflow-x:hidden;overflow-y:auto;overflow-y:overlay;background-color:var(--color-background);color:var(--color-foreground);font-family:var(--font-sans)}html:not(.dark) .shiki-dark{display:none}body{height:100%;margin:auto;padding:0;max-width:75ch}h1{font-size:1.875rem;line-height:2.25rem;font-weight:700}button{outline:2px solid transparent!important;outline-offset:2px!important}#md a,#md a *{text-decoration-skip-ink:auto;color:var(--color-accent);transition:all .2s ease-in}#md a :hover,#md a:hover{color:var(--color-secondary);transition:all .3s ease-out}#md em{padding-right:.25ch}#md h2{margin:1.25em 0 .75em;font-family:var(--font-serif);font-weight:700}#md h2{font-size:1.5em}#md p{margin:1em 0}#md h2:first-child,#md p:first-child,#md pre:first-child{margin-top:0}#md h2:last-child,#md p:last-child,#md pre:last-child{margin-bottom:0}#md a{text-decoration:underline;text-decoration-skip-ink:auto}#md hr{border:0;height:0;border-bottom:1px solid var(--color-foreground)}#md hr.talk-separator{height:1.5em;border:none;overflow:visible;text-align:center}#md hr.talk-separator:after{position:relative;content:"***";letter-spacing:.5em;background:0 0}#md hr.talk-separator+h2{margin-top:0}#md ul{margin:1em 0;padding-left:1em}#md ul{list-style:disc}#md li{line-height:150%;margin:.25em 0}#md pre pre{border-radius:.25rem;padding:1em;max-width:100%;overflow:auto}#md p code{font-size:.95rem;padding:.2em}#md code,#md pre{font-family:var(--font-mono);line-height:154%}#md pre{margin:1em 0}</style><link rel="preload" href="/assets/app.20db8728.css" as="style"><link rel="modulepreload" crossorigin="" href="/assets/rust-postmortem.6e46bec1.js"><link rel="modulepreload" crossorigin="" href="/assets/TheArticle.2efce49e.js"><title>In Rust We Bust | Pak</title><meta name="description" content="Rust è¯­è¨€çš„è¸©å‘è®°å½•ã€‚"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css" integrity="sha384-zTROYFVGOfTw7JV7KUu8udsvW2fx4lWOsCEDqhBreBwlHI4ioVRtmIvEThzJHGET" crossorigin="anonymous"><meta name="head:count" content="2"></head><body><div id="app" data-server-rendered="true"><!--[--><header class="flex justify-between items-center my-4 gap-2" data-v-adef6890=""><nav class="inline-block px-2 py-1 rounded transition-lively" text="bgd" bg="acc hover:sec" font="mono bold" data-v-adef6890=""><a href="/" class="" data-v-adef6890="">pÎ±k</a></nav><nav class="flex justify-between items-center gap-3" data-v-adef6890=""><button transition-lively="" class="hover:text-sec" data-v-adef6890=""><a href="/archive" class="" data-v-adef6890=""><div i-mdi-text-box="" data-v-adef6890=""></div></a></button><button transition-lively="" class="hover:text-sec" data-v-adef6890=""><a href="/posts" class="" data-v-adef6890=""><div i-mdi-file="" data-v-adef6890=""></div></a></button><button transition-lively="" class="hover:text-sec" data-v-adef6890=""><a href="/sheets" class="" data-v-adef6890=""><div i-mdi-table-large="" data-v-adef6890=""></div></a></button><button transition-lively="" class="hover:text-sec" data-v-adef6890=""><a href="/notes" class="" data-v-adef6890=""><div i-mdi-folder="" data-v-adef6890=""></div></a></button></nav></header><main class="text-left"><main class="mb-8"><article class="text-left"><header class="flex flex-col justify-start items-start gap-2 mt-4 mb-8"><h1>In Rust We Bust</h1><div class="flex flex-wrap gap-x-1 gap-y-0.5 justify-start items-center"><span class="flex justify-center"><button btn-icon=""><a href="/notes" class=""><div class="i-mdi-folder"></div></a></button></span><span class="flex gap-1 justify-center items-center"><span class="inline-block text-xs rounded p-1 font-mono font-bold transition-lively"><!--[--><time>2022/05/19</time><!--]--></span></span><span class="flex gap-1 justify-center items-center"><span class="inline-block text-xs rounded p-1 font-mono font-bold transition-lively text-acc hover:bg-acc hover:text-bgd"><!--[--><a href="/categories/comp" class="">comp</a><!--]--></span></span><span class="flex gap-1 justify-center items-center"><!--[--><span class="inline-block text-xs rounded p-1 font-mono font-bold transition-lively text-sec hover:bg-sec hover:text-bgd"><!--[--><a href="/tags?tag=rust" class=""> @rust</a><!--]--></span><span class="inline-block text-xs rounded p-1 font-mono font-bold transition-lively text-sec hover:bg-sec hover:text-bgd"><!--[--><a href="/tags?tag=pl" class=""> @pl</a><!--]--></span><!--]--></span><span class="flex gap-1 justify-center items-center"><!--[--><!--]--></span></div></header><article id="md"><div><p>Rust è¯­è¨€çš„è¸©å‘è®°å½•ã€‚</p><!-- more --><p><s>å¯¹ <code>rustc</code> æ–½ç”¨ <a href="https://harrypotter.fandom.com/wiki/Silencing_Charm" target="_blank" rel="noopener"><code>Silencio</code></a> å¯ä¸èƒ½è§£å†³é—®é¢˜</s>ã€‚</p><h2 id="refcell-å’Œä½œç”¨åŸŸ" tabindex="-1"><code>RefCell</code> å’Œä½œç”¨åŸŸ</h2><p>Rust é€šè¿‡ <code>std::cell</code> æä¾›çš„â€œå†…éƒ¨å¯å˜æ€§â€çœ‹èµ·æ¥å¾ˆçˆ½â€”â€”å¯ä»¥æŠŠä¸€ä¸ªä¸å¯å˜çš„æ•°æ®çš„ä¸€éƒ¨åˆ†ææˆå¯å˜çš„ã€‚å…¶ä¸­çš„ <code>RefCell</code> å¯ä»¥æŠŠ<s>ç¾åè¿œæ‰¬</s>çš„ç¼–è¯‘æœŸ <code>borrowck</code> æåˆ°è¿è¡ŒæœŸå»ï¼Œå®ç°å¾€ä¸å¯å˜æ•°æ®å†…éƒ¨æŒ‡ä¸€ä¸ªå¯å†™çš„æŒ‡é’ˆ <code>RefMut</code> çš„åŠŸèƒ½ğŸ¤—ã€‚</p><p>é‚£ä¹ˆèƒ½ä¸èƒ½æŠŠåŸæ•°æ®ç”¨ <code>RefCell</code> ä¸€åŒ…ï¼Œç„¶åç›´æ¥æŠŠ <code>&amp;x, &amp;mut x</code> æ›¿æ¢æˆ <code>x.borrow(), x.borrow_mut()</code> ï¼Ÿç¼–è¯‘å™¨ä¼šç­”åº”ï¼Œä½†ä½œç”¨åŸŸé—®é¢˜å¯èƒ½ä¼šå¯¼è‡´è¿è¡Œæ—¶ panicğŸ™ƒã€‚</p><p>è€ƒè™‘ä¸‹é¢ä¸€æ®µä»£ç ï¼š</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#282c34"><code><span class="line"><span style="color:#abb2bf">#[allow(unused)]</span></span>
<span class="line"><span style="color:#c678dd">fn</span><span style="color:#abb2bf"> </span><span style="color:#61afef">main</span><span style="color:#abb2bf">() {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">mut</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">x</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt; </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">None</span><span style="color:#abb2bf">;</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">y</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> &amp;</span><span style="color:#e06c75">x</span><span style="color:#abb2bf">;</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">if</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">y</span><span style="color:#abb2bf">.</span><span style="color:#61afef">is_none</span><span style="color:#abb2bf">() {</span></span>
<span class="line"><span style="color:#abb2bf">        </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">z</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> &amp;</span><span style="color:#c678dd">mut</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">x</span><span style="color:#abb2bf">;</span></span>
<span class="line"><span style="color:#abb2bf">    }</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#24292f">#[allow(unused)]</span></span>
<span class="line"><span style="color:#cf222e">fn</span><span style="color:#24292f"> </span><span style="color:#8250df">main</span><span style="color:#24292f">() {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> </span><span style="color:#cf222e">mut</span><span style="color:#24292f"> x</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt; </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">None</span><span style="color:#24292f">;</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> y </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;</span><span style="color:#24292f">x;</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">if</span><span style="color:#24292f"> y</span><span style="color:#cf222e">.</span><span style="color:#8250df">is_none</span><span style="color:#24292f">() {</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#cf222e">let</span><span style="color:#24292f"> z </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;mut</span><span style="color:#24292f"> x;</span></span>
<span class="line"><span style="color:#24292f">    }</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span></code></pre></div></code></pre><p>é—®é¢˜å…¨ç„¶æ— ï¼Œç¼–è¯‘é€šè¿‡ã€‚<code>y</code> æ˜¯ä¸å¯å˜å¼•ç”¨ï¼Œä½†æ˜¯åœ¨ <code>if</code> çš„è¡¨è¾¾å¼é‡Œåªç”¨è¿‡ä¸€æ¬¡å°±æ²¡å†ç”¨è¿‡ï¼Œå› æ­¤ <code>z</code> å¯ä»¥é«˜é«˜å…´å…´åœ°å€Ÿå‡ºå¯å˜å¼•ç”¨ã€‚çœ‹çœ‹ MIRï¼š</p><pre><code class="language-sh"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#282c34"><code><span class="line"><span style="color:#abb2bf">$ rustc src/main.rs --emit mir</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#24292f">$ rustc src/main.rs --emit mir</span></span>
<span class="line"></span></code></pre></div></code></pre><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#282c34"><code><span class="line"><span style="color:#e06c75">scope</span><span style="color:#abb2bf"> </span><span style="color:#d19a66">1</span><span style="color:#abb2bf"> {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">debug</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">x</span><span style="color:#abb2bf"> =&gt; </span><span style="color:#e06c75">_1</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                   // in scope 1</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_2</span><span style="color:#abb2bf">: &amp;</span><span style="color:#e5c07b">std</span><span style="color:#abb2bf">::</span><span style="color:#e5c07b">option</span><span style="color:#abb2bf">::</span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;;</span><span style="color:#7f848e;font-style:italic"> // in scope 1</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">scope</span><span style="color:#abb2bf"> </span><span style="color:#d19a66">2</span><span style="color:#abb2bf"> {</span></span>
<span class="line"><span style="color:#abb2bf">        </span><span style="color:#e06c75">debug</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">y</span><span style="color:#abb2bf"> =&gt; </span><span style="color:#e06c75">_2</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">               // in scope 2</span></span>
<span class="line"><span style="color:#abb2bf">        </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_5</span><span style="color:#abb2bf">: &amp;</span><span style="color:#c678dd">mut</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">std</span><span style="color:#abb2bf">::</span><span style="color:#e5c07b">option</span><span style="color:#abb2bf">::</span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;;</span><span style="color:#7f848e;font-style:italic"> // in scope 2</span></span>
<span class="line"><span style="color:#abb2bf">        </span><span style="color:#e06c75">scope</span><span style="color:#abb2bf"> </span><span style="color:#d19a66">3</span><span style="color:#abb2bf"> {</span></span>
<span class="line"><span style="color:#abb2bf">            </span><span style="color:#e06c75">debug</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">z</span><span style="color:#abb2bf"> =&gt; </span><span style="color:#e06c75">_5</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">           // in scope 3</span></span>
<span class="line"><span style="color:#abb2bf">        }</span></span>
<span class="line"><span style="color:#abb2bf">    }</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e06c75">bb0</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#61afef">discriminant</span><span style="color:#abb2bf">(</span><span style="color:#e06c75">_1</span><span style="color:#abb2bf">) </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#d19a66">0</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">            // scope 0</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_2</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> &amp;</span><span style="color:#e06c75">_1</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                        // scope 1</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_4</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_2</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                         // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_3</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">::&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;::</span><span style="color:#61afef">is_none</span><span style="color:#abb2bf">(</span><span style="color:#c678dd">move</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_4</span><span style="color:#abb2bf">) -&gt; </span><span style="color:#e06c75">bb1</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic"> // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e06c75">bb1</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#61afef">switchInt</span><span style="color:#abb2bf">(</span><span style="color:#c678dd">move</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_3</span><span style="color:#abb2bf">) -&gt; [</span><span style="color:#d19a66">false</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">bb3</span><span style="color:#abb2bf">, </span><span style="color:#e06c75">otherwise</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">bb2</span><span style="color:#abb2bf">];</span><span style="color:#7f848e;font-style:italic"> // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e06c75">bb2</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_5</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> &amp;</span><span style="color:#c678dd">mut</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_1</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                    // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">goto</span><span style="color:#abb2bf"> -&gt; </span><span style="color:#e06c75">bb3</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                     // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e06c75">bb3</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">return</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                          // scope 0</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#24292f">scope </span><span style="color:#0550ae">1</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    debug x </span><span style="color:#cf222e">=&gt;</span><span style="color:#24292f"> _1;</span><span style="color:#6e7781">                   // in scope 1</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> _2</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;</span><span style="color:#953800">std</span><span style="color:#cf222e">::</span><span style="color:#953800">option</span><span style="color:#cf222e">::</span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt;;</span><span style="color:#6e7781"> // in scope 1</span></span>
<span class="line"><span style="color:#24292f">    scope </span><span style="color:#0550ae">2</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">        debug y </span><span style="color:#cf222e">=&gt;</span><span style="color:#24292f"> _2;</span><span style="color:#6e7781">               // in scope 2</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#cf222e">let</span><span style="color:#24292f"> _5</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;mut</span><span style="color:#24292f"> </span><span style="color:#953800">std</span><span style="color:#cf222e">::</span><span style="color:#953800">option</span><span style="color:#cf222e">::</span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt;;</span><span style="color:#6e7781"> // in scope 2</span></span>
<span class="line"><span style="color:#24292f">        scope </span><span style="color:#0550ae">3</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">            debug z </span><span style="color:#cf222e">=&gt;</span><span style="color:#24292f"> _5;</span><span style="color:#6e7781">           // in scope 3</span></span>
<span class="line"><span style="color:#24292f">        }</span></span>
<span class="line"><span style="color:#24292f">    }</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">bb0</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">discriminant</span><span style="color:#24292f">(_1) </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#0550ae">0</span><span style="color:#24292f">;</span><span style="color:#6e7781">            // scope 0</span></span>
<span class="line"><span style="color:#24292f">    _2 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;</span><span style="color:#24292f">_1;</span><span style="color:#6e7781">                        // scope 1</span></span>
<span class="line"><span style="color:#24292f">    _4 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> _2;</span><span style="color:#6e7781">                         // scope 2</span></span>
<span class="line"><span style="color:#24292f">    _3 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">Option</span><span style="color:#cf222e">::</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt;</span><span style="color:#cf222e">::</span><span style="color:#8250df">is_none</span><span style="color:#24292f">(</span><span style="color:#cf222e">move</span><span style="color:#24292f"> _4) </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> bb1;</span><span style="color:#6e7781"> // scope 2</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">bb1</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">switchInt</span><span style="color:#24292f">(</span><span style="color:#cf222e">move</span><span style="color:#24292f"> _3) </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> [</span><span style="color:#0550ae">false</span><span style="color:#cf222e">:</span><span style="color:#24292f"> bb3, otherwise</span><span style="color:#cf222e">:</span><span style="color:#24292f"> bb2];</span><span style="color:#6e7781"> // scope 2</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">bb2</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    _5 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;mut</span><span style="color:#24292f"> _1;</span><span style="color:#6e7781">                    // scope 2</span></span>
<span class="line"><span style="color:#24292f">    goto </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> bb3;</span><span style="color:#6e7781">                     // scope 2</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">bb3</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">return</span><span style="color:#24292f">;</span><span style="color:#6e7781">                          // scope 0</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span></code></pre></div></code></pre><p><code>y(_2)</code> åªåœ¨åŸºæœ¬å— <code>0</code> å‡ºç°ã€‚è·³è½¬åˆ°åŸºæœ¬å— <code>2</code>ï¼Œ<code>z(_5)</code> å€Ÿå¯å˜å¼•ç”¨çš„æ—¶å€™æ²¡æœ‰ <code>x</code> çš„ä¸å¯å˜å¼•ç”¨äº†ï¼Œ<code>borrowck</code> æ”¾è¡Œã€‚</p><p>å¦‚æœæ›¿æ¢æˆ <code>RefCell</code> å‘¢ï¼Ÿ</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#282c34"><code><span class="line"><span style="color:#abb2bf">#[allow(unused)]</span></span>
<span class="line"><span style="color:#c678dd">fn</span><span style="color:#abb2bf"> </span><span style="color:#61afef">main</span><span style="color:#abb2bf">() {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">x</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">RefCell</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;&gt; </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">RefCell</span><span style="color:#abb2bf">::</span><span style="color:#61afef">new</span><span style="color:#abb2bf">(</span><span style="color:#e5c07b">None</span><span style="color:#abb2bf">);</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">y</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">x</span><span style="color:#abb2bf">.</span><span style="color:#61afef">borrow</span><span style="color:#abb2bf">();</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">if</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">y</span><span style="color:#abb2bf">.</span><span style="color:#61afef">is_none</span><span style="color:#abb2bf">() {</span></span>
<span class="line"><span style="color:#abb2bf">        </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">z</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">x</span><span style="color:#abb2bf">.</span><span style="color:#61afef">borrow_mut</span><span style="color:#abb2bf">();</span><span style="color:#7f848e;font-style:italic"> // &lt;- thread 'main' panicked at 'already borrowed: BorrowMutError'</span></span>
<span class="line"><span style="color:#abb2bf">    }</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#24292f">#[allow(unused)]</span></span>
<span class="line"><span style="color:#cf222e">fn</span><span style="color:#24292f"> </span><span style="color:#8250df">main</span><span style="color:#24292f">() {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> x</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">RefCell</span><span style="color:#24292f">&lt;</span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt;&gt; </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">RefCell</span><span style="color:#cf222e">::</span><span style="color:#8250df">new</span><span style="color:#24292f">(</span><span style="color:#953800">None</span><span style="color:#24292f">);</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> y </span><span style="color:#cf222e">=</span><span style="color:#24292f"> x</span><span style="color:#cf222e">.</span><span style="color:#8250df">borrow</span><span style="color:#24292f">();</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">if</span><span style="color:#24292f"> y</span><span style="color:#cf222e">.</span><span style="color:#8250df">is_none</span><span style="color:#24292f">() {</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#cf222e">let</span><span style="color:#24292f"> z </span><span style="color:#cf222e">=</span><span style="color:#24292f"> x</span><span style="color:#cf222e">.</span><span style="color:#8250df">borrow_mut</span><span style="color:#24292f">();</span><span style="color:#6e7781"> // &lt;- thread 'main' panicked at 'already borrowed: BorrowMutError'</span></span>
<span class="line"><span style="color:#24292f">    }</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span></code></pre></div></code></pre><p>panic äº†ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#282c34"><code><span class="line"><span style="color:#e06c75">scope</span><span style="color:#abb2bf"> </span><span style="color:#d19a66">1</span><span style="color:#abb2bf"> {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">debug</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">x</span><span style="color:#abb2bf"> =&gt; </span><span style="color:#e06c75">_1</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                   // in scope 1</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_3</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">std</span><span style="color:#abb2bf">::</span><span style="color:#e5c07b">cell</span><span style="color:#abb2bf">::</span><span style="color:#e5c07b">Ref</span><span style="color:#abb2bf">&lt;</span><span style="color:#e06c75">std</span><span style="color:#abb2bf">::</span><span style="color:#e06c75">option</span><span style="color:#abb2bf">::</span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;&gt;;</span><span style="color:#7f848e;font-style:italic"> // in scope 1</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">scope</span><span style="color:#abb2bf"> </span><span style="color:#d19a66">2</span><span style="color:#abb2bf"> {</span></span>
<span class="line"><span style="color:#abb2bf">        </span><span style="color:#e06c75">debug</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">y</span><span style="color:#abb2bf"> =&gt; </span><span style="color:#e06c75">_3</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">               // in scope 2</span></span>
<span class="line"><span style="color:#abb2bf">        </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_9</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">std</span><span style="color:#abb2bf">::</span><span style="color:#e5c07b">cell</span><span style="color:#abb2bf">::</span><span style="color:#e5c07b">RefMut</span><span style="color:#abb2bf">&lt;</span><span style="color:#e06c75">std</span><span style="color:#abb2bf">::</span><span style="color:#e06c75">option</span><span style="color:#abb2bf">::</span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;&gt;;</span><span style="color:#7f848e;font-style:italic"> // in scope 2</span></span>
<span class="line"><span style="color:#abb2bf">        </span><span style="color:#e06c75">scope</span><span style="color:#abb2bf"> </span><span style="color:#d19a66">3</span><span style="color:#abb2bf"> {</span></span>
<span class="line"><span style="color:#abb2bf">            </span><span style="color:#e06c75">debug</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">z</span><span style="color:#abb2bf"> =&gt; </span><span style="color:#e06c75">_9</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">           // in scope 3</span></span>
<span class="line"><span style="color:#abb2bf">        }</span></span>
<span class="line"><span style="color:#abb2bf">    }</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e06c75">bb0</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#61afef">discriminant</span><span style="color:#abb2bf">(</span><span style="color:#e06c75">_2</span><span style="color:#abb2bf">) </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#d19a66">0</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">            // scope 0</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_1</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">RefCell</span><span style="color:#abb2bf">::&lt;</span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;&gt;::</span><span style="color:#61afef">new</span><span style="color:#abb2bf">(</span><span style="color:#c678dd">move</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_2</span><span style="color:#abb2bf">) -&gt; </span><span style="color:#e06c75">bb1</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic"> // scope 0</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e06c75">bb1</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_4</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> &amp;</span><span style="color:#e06c75">_1</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                        // scope 1</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_3</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">RefCell</span><span style="color:#abb2bf">::&lt;</span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;&gt;::</span><span style="color:#61afef">borrow</span><span style="color:#abb2bf">(</span><span style="color:#c678dd">move</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_4</span><span style="color:#abb2bf">) -&gt; </span><span style="color:#e06c75">bb2</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic"> // scope 1</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e06c75">bb2</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_8</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> &amp;</span><span style="color:#e06c75">_3</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                        // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_7</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> &lt;</span><span style="color:#e5c07b">Ref</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;&gt; </span><span style="color:#c678dd">as</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Deref</span><span style="color:#abb2bf">&gt;::</span><span style="color:#61afef">deref</span><span style="color:#abb2bf">(</span><span style="color:#c678dd">move</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_8</span><span style="color:#abb2bf">) -&gt; [</span><span style="color:#c678dd">return</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">bb3</span><span style="color:#abb2bf">, </span><span style="color:#e06c75">unwind</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">bb9</span><span style="color:#abb2bf">];</span><span style="color:#7f848e;font-style:italic"> // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e06c75">bb3</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_6</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_7</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                         // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_5</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">::&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;::</span><span style="color:#61afef">is_none</span><span style="color:#abb2bf">(</span><span style="color:#c678dd">move</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_6</span><span style="color:#abb2bf">) -&gt; [</span><span style="color:#c678dd">return</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">bb4</span><span style="color:#abb2bf">, </span><span style="color:#e06c75">unwind</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">bb9</span><span style="color:#abb2bf">];</span><span style="color:#7f848e;font-style:italic"> // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e06c75">bb4</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#61afef">switchInt</span><span style="color:#abb2bf">(</span><span style="color:#c678dd">move</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_5</span><span style="color:#abb2bf">) -&gt; [</span><span style="color:#d19a66">false</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">bb7</span><span style="color:#abb2bf">, </span><span style="color:#e06c75">otherwise</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">bb5</span><span style="color:#abb2bf">];</span><span style="color:#7f848e;font-style:italic"> // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e06c75">bb5</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_10</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> &amp;</span><span style="color:#e06c75">_1</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                       // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_9</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">RefCell</span><span style="color:#abb2bf">::&lt;</span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;&gt;::</span><span style="color:#61afef">borrow_mut</span><span style="color:#abb2bf">(</span><span style="color:#c678dd">move</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_10</span><span style="color:#abb2bf">) -&gt; [</span><span style="color:#c678dd">return</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">bb6</span><span style="color:#abb2bf">, </span><span style="color:#e06c75">unwind</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">bb9</span><span style="color:#abb2bf">];</span><span style="color:#7f848e;font-style:italic"> // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7f848e;font-style:italic">/* z åœ¨è¿™é‡Œææ„ */</span></span>
<span class="line"><span style="color:#e06c75">bb6</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#61afef">drop</span><span style="color:#abb2bf">(</span><span style="color:#e06c75">_9</span><span style="color:#abb2bf">) -&gt; [</span><span style="color:#c678dd">return</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">bb7</span><span style="color:#abb2bf">, </span><span style="color:#e06c75">unwind</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">bb9</span><span style="color:#abb2bf">];</span><span style="color:#7f848e;font-style:italic"> // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7f848e;font-style:italic">/* y åœ¨è¿™é‡Œæ‰ææ„ */</span></span>
<span class="line"><span style="color:#e06c75">bb7</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#61afef">drop</span><span style="color:#abb2bf">(</span><span style="color:#e06c75">_3</span><span style="color:#abb2bf">) -&gt; </span><span style="color:#e06c75">bb8</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                 // scope 1</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e06c75">bb8</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">return</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                          // scope 0</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7f848e;font-style:italic">// ...</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#24292f">scope </span><span style="color:#0550ae">1</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    debug x </span><span style="color:#cf222e">=&gt;</span><span style="color:#24292f"> _1;</span><span style="color:#6e7781">                   // in scope 1</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> _3</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">std</span><span style="color:#cf222e">::</span><span style="color:#953800">cell</span><span style="color:#cf222e">::</span><span style="color:#953800">Ref</span><span style="color:#24292f">&lt;std</span><span style="color:#cf222e">::</span><span style="color:#24292f">option</span><span style="color:#cf222e">::</span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt;&gt;;</span><span style="color:#6e7781"> // in scope 1</span></span>
<span class="line"><span style="color:#24292f">    scope </span><span style="color:#0550ae">2</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">        debug y </span><span style="color:#cf222e">=&gt;</span><span style="color:#24292f"> _3;</span><span style="color:#6e7781">               // in scope 2</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#cf222e">let</span><span style="color:#24292f"> _9</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">std</span><span style="color:#cf222e">::</span><span style="color:#953800">cell</span><span style="color:#cf222e">::</span><span style="color:#953800">RefMut</span><span style="color:#24292f">&lt;std</span><span style="color:#cf222e">::</span><span style="color:#24292f">option</span><span style="color:#cf222e">::</span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt;&gt;;</span><span style="color:#6e7781"> // in scope 2</span></span>
<span class="line"><span style="color:#24292f">        scope </span><span style="color:#0550ae">3</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">            debug z </span><span style="color:#cf222e">=&gt;</span><span style="color:#24292f"> _9;</span><span style="color:#6e7781">           // in scope 3</span></span>
<span class="line"><span style="color:#24292f">        }</span></span>
<span class="line"><span style="color:#24292f">    }</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">bb0</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">discriminant</span><span style="color:#24292f">(_2) </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#0550ae">0</span><span style="color:#24292f">;</span><span style="color:#6e7781">            // scope 0</span></span>
<span class="line"><span style="color:#24292f">    _1 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">RefCell</span><span style="color:#cf222e">::</span><span style="color:#24292f">&lt;</span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt;&gt;</span><span style="color:#cf222e">::</span><span style="color:#8250df">new</span><span style="color:#24292f">(</span><span style="color:#cf222e">move</span><span style="color:#24292f"> _2) </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> bb1;</span><span style="color:#6e7781"> // scope 0</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">bb1</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    _4 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;</span><span style="color:#24292f">_1;</span><span style="color:#6e7781">                        // scope 1</span></span>
<span class="line"><span style="color:#24292f">    _3 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">RefCell</span><span style="color:#cf222e">::</span><span style="color:#24292f">&lt;</span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt;&gt;</span><span style="color:#cf222e">::</span><span style="color:#8250df">borrow</span><span style="color:#24292f">(</span><span style="color:#cf222e">move</span><span style="color:#24292f"> _4) </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> bb2;</span><span style="color:#6e7781"> // scope 1</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">bb2</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    _8 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;</span><span style="color:#24292f">_3;</span><span style="color:#6e7781">                        // scope 2</span></span>
<span class="line"><span style="color:#24292f">    _7 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> &lt;</span><span style="color:#953800">Ref</span><span style="color:#24292f">&lt;</span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt;&gt; </span><span style="color:#cf222e">as</span><span style="color:#24292f"> </span><span style="color:#953800">Deref</span><span style="color:#24292f">&gt;</span><span style="color:#cf222e">::</span><span style="color:#8250df">deref</span><span style="color:#24292f">(</span><span style="color:#cf222e">move</span><span style="color:#24292f"> _8) </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> [</span><span style="color:#cf222e">return:</span><span style="color:#24292f"> bb3, unwind</span><span style="color:#cf222e">:</span><span style="color:#24292f"> bb9];</span><span style="color:#6e7781"> // scope 2</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">bb3</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    _6 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> _7;</span><span style="color:#6e7781">                         // scope 2</span></span>
<span class="line"><span style="color:#24292f">    _5 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">Option</span><span style="color:#cf222e">::</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt;</span><span style="color:#cf222e">::</span><span style="color:#8250df">is_none</span><span style="color:#24292f">(</span><span style="color:#cf222e">move</span><span style="color:#24292f"> _6) </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> [</span><span style="color:#cf222e">return:</span><span style="color:#24292f"> bb4, unwind</span><span style="color:#cf222e">:</span><span style="color:#24292f"> bb9];</span><span style="color:#6e7781"> // scope 2</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">bb4</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">switchInt</span><span style="color:#24292f">(</span><span style="color:#cf222e">move</span><span style="color:#24292f"> _5) </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> [</span><span style="color:#0550ae">false</span><span style="color:#cf222e">:</span><span style="color:#24292f"> bb7, otherwise</span><span style="color:#cf222e">:</span><span style="color:#24292f"> bb5];</span><span style="color:#6e7781"> // scope 2</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">bb5</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    _10 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;</span><span style="color:#24292f">_1;</span><span style="color:#6e7781">                       // scope 2</span></span>
<span class="line"><span style="color:#24292f">    _9 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">RefCell</span><span style="color:#cf222e">::</span><span style="color:#24292f">&lt;</span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt;&gt;</span><span style="color:#cf222e">::</span><span style="color:#8250df">borrow_mut</span><span style="color:#24292f">(</span><span style="color:#cf222e">move</span><span style="color:#24292f"> _10) </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> [</span><span style="color:#cf222e">return:</span><span style="color:#24292f"> bb6, unwind</span><span style="color:#cf222e">:</span><span style="color:#24292f"> bb9];</span><span style="color:#6e7781"> // scope 2</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6e7781">/* z åœ¨è¿™é‡Œææ„ */</span></span>
<span class="line"><span style="color:#24292f">bb6</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">drop</span><span style="color:#24292f">(_9) </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> [</span><span style="color:#cf222e">return:</span><span style="color:#24292f"> bb7, unwind</span><span style="color:#cf222e">:</span><span style="color:#24292f"> bb9];</span><span style="color:#6e7781"> // scope 2</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6e7781">/* y åœ¨è¿™é‡Œæ‰ææ„ */</span></span>
<span class="line"><span style="color:#24292f">bb7</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">drop</span><span style="color:#24292f">(_3) </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> bb8;</span><span style="color:#6e7781">                 // scope 1</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">bb8</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">return</span><span style="color:#24292f">;</span><span style="color:#6e7781">                          // scope 0</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6e7781">// ...</span></span>
<span class="line"></span></code></pre></div></code></pre><p>ä½œç”¨åŸŸæ˜¯ä¸€æ ·çš„å•Šï¼Ÿä½†æ˜¯æ³¨æ„ï¼Œ<code>y(_3)</code> ä» <code>RefCell</code> å€Ÿå‡ºçš„ <code>Ref</code> æ˜¯æ™ºèƒ½æŒ‡é’ˆï¼Œéœ€è¦ææ„è¿™ä¸€æ­¥ï¼Œå®ƒä¸€ç›´ä¿æŒåˆ° <code>if</code> ä½œç”¨åŸŸçš„å°¾éƒ¨ï¼Œä¹Ÿå°±æ˜¯åŸºæœ¬å— <code>7</code> æ‰ææ„ï¼åœ¨æ­¤ä¹‹å‰åŸºæœ¬å— <code>5</code> è¦æ±‚å€Ÿå‡º <code>RefMut</code>ï¼Œäºæ˜¯å½“åœº panicğŸ˜±ã€‚</p><p>æ€ä¹ˆè§£å†³å‘¢ï¼Ÿæ‰‹åŠ¨ <code>drop()</code>ğŸ¤ªï¼äº‹å®ä¸Šï¼Œ<code>mem::drop</code> çš„æ–‡æ¡£å·²ç»ç»™å‡ºäº†ç±»ä¼¼çš„<a href="https://doc.rust-lang.org/std/mem/fn.drop.html#examples" target="_blank" rel="noopener">ä¾‹å­</a>ã€‚</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#282c34"><code><span class="line"><span style="color:#abb2bf">#[allow(unused)]</span></span>
<span class="line"><span style="color:#c678dd">fn</span><span style="color:#abb2bf"> </span><span style="color:#61afef">main</span><span style="color:#abb2bf">() {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">x</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">RefCell</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;&gt; </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">RefCell</span><span style="color:#abb2bf">::</span><span style="color:#61afef">new</span><span style="color:#abb2bf">(</span><span style="color:#e5c07b">None</span><span style="color:#abb2bf">);</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">y</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">x</span><span style="color:#abb2bf">.</span><span style="color:#61afef">borrow</span><span style="color:#abb2bf">();</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">if</span><span style="color:#abb2bf"> { </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">b</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">y</span><span style="color:#abb2bf">.</span><span style="color:#61afef">is_none</span><span style="color:#abb2bf">(); </span><span style="color:#61afef">drop</span><span style="color:#abb2bf">(</span><span style="color:#e06c75">y</span><span style="color:#abb2bf">); </span><span style="color:#e06c75">b</span><span style="color:#abb2bf"> } {</span></span>
<span class="line"><span style="color:#abb2bf">        </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">z</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">x</span><span style="color:#abb2bf">.</span><span style="color:#61afef">borrow_mut</span><span style="color:#abb2bf">();</span></span>
<span class="line"><span style="color:#abb2bf">    }</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#24292f">#[allow(unused)]</span></span>
<span class="line"><span style="color:#cf222e">fn</span><span style="color:#24292f"> </span><span style="color:#8250df">main</span><span style="color:#24292f">() {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> x</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">RefCell</span><span style="color:#24292f">&lt;</span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt;&gt; </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">RefCell</span><span style="color:#cf222e">::</span><span style="color:#8250df">new</span><span style="color:#24292f">(</span><span style="color:#953800">None</span><span style="color:#24292f">);</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> y </span><span style="color:#cf222e">=</span><span style="color:#24292f"> x</span><span style="color:#cf222e">.</span><span style="color:#8250df">borrow</span><span style="color:#24292f">();</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">if</span><span style="color:#24292f"> { </span><span style="color:#cf222e">let</span><span style="color:#24292f"> b </span><span style="color:#cf222e">=</span><span style="color:#24292f"> y</span><span style="color:#cf222e">.</span><span style="color:#8250df">is_none</span><span style="color:#24292f">(); </span><span style="color:#8250df">drop</span><span style="color:#24292f">(y); b } {</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#cf222e">let</span><span style="color:#24292f"> z </span><span style="color:#cf222e">=</span><span style="color:#24292f"> x</span><span style="color:#cf222e">.</span><span style="color:#8250df">borrow_mut</span><span style="color:#24292f">();</span></span>
<span class="line"><span style="color:#24292f">    }</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span></code></pre></div></code></pre><hr class="talk-separator"><h2 id="åˆå§‹åŒ–å™¨ä¹Ÿæ˜¯è¡¨è¾¾å¼" tabindex="-1">åˆå§‹åŒ–å™¨ä¹Ÿæ˜¯è¡¨è¾¾å¼</h2><p><s>è¿™ä¸æ˜¯æ˜¾ç„¶çš„å—</s>ï¼Ÿ</p><p>å…ƒç»„ï¼ˆtupleï¼‰å’Œæ•°ç»„ï¼ˆarrayï¼‰éƒ½æ˜¯ Rust çš„åŸºæœ¬ç±»å‹ï¼ˆprimitive typeï¼‰ã€‚å…ƒç»„çš„åˆå§‹åŒ–å™¨ç”¨ <code>()</code>ï¼Œæ•°ç»„ç”¨ <code>[]</code>ï¼Œåˆ†éš”ç¬¦æ˜¯ <code>,</code>ã€‚è™½ç„¶åˆå§‹åŒ–å™¨<em>æ˜¾ç„¶</em>æ˜¯è¡¨è¾¾å¼ï¼Œä½†æœ‰æ—¶å€™é€—å·ä¸€åŠ ï¼Œå°±éš¾å…æƒ³è¿™æ ·å†™ï¼š</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#282c34"><code><span class="line"><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">cell</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">RefCell</span><span style="color:#abb2bf">::</span><span style="color:#61afef">new</span><span style="color:#abb2bf">(</span><span style="color:#61afef">vec!</span><span style="color:#abb2bf">[</span><span style="color:#d19a66">1</span><span style="color:#abb2bf">, </span><span style="color:#d19a66">2</span><span style="color:#abb2bf">, </span><span style="color:#d19a66">3</span><span style="color:#abb2bf">]);</span></span>
<span class="line"><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">values</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> (</span></span>
<span class="line"><span style="color:#abb2bf">  </span><span style="color:#e06c75">cell</span><span style="color:#abb2bf">.</span><span style="color:#61afef">borrow_mut</span><span style="color:#abb2bf">().</span><span style="color:#61afef">iter</span><span style="color:#abb2bf">().</span><span style="color:#61afef">max</span><span style="color:#abb2bf">().</span><span style="color:#61afef">cloned</span><span style="color:#abb2bf">(),</span></span>
<span class="line"><span style="color:#abb2bf">  </span><span style="color:#e06c75">cell</span><span style="color:#abb2bf">.</span><span style="color:#61afef">borrow_mut</span><span style="color:#abb2bf">().</span><span style="color:#61afef">iter</span><span style="color:#abb2bf">().</span><span style="color:#61afef">min</span><span style="color:#abb2bf">().</span><span style="color:#61afef">cloned</span><span style="color:#abb2bf">(), </span></span>
<span class="line"><span style="color:#abb2bf">  </span><span style="color:#7f848e;font-style:italic">/*   ^^^^^^^^^^ </span></span>
<span class="line"><span style="color:#7f848e;font-style:italic">       thread 'main' panicked at 'already borrowed: BorrowMutError'</span></span>
<span class="line"><span style="color:#7f848e;font-style:italic">  */</span></span>
<span class="line"><span style="color:#abb2bf">);</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#cf222e">let</span><span style="color:#24292f"> cell </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">RefCell</span><span style="color:#cf222e">::</span><span style="color:#8250df">new</span><span style="color:#24292f">(</span><span style="color:#8250df">vec!</span><span style="color:#24292f">[</span><span style="color:#0550ae">1</span><span style="color:#24292f">, </span><span style="color:#0550ae">2</span><span style="color:#24292f">, </span><span style="color:#0550ae">3</span><span style="color:#24292f">]);</span></span>
<span class="line"><span style="color:#cf222e">let</span><span style="color:#24292f"> values </span><span style="color:#cf222e">=</span><span style="color:#24292f"> (</span></span>
<span class="line"><span style="color:#24292f">  cell</span><span style="color:#cf222e">.</span><span style="color:#8250df">borrow_mut</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">iter</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">max</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">cloned</span><span style="color:#24292f">(),</span></span>
<span class="line"><span style="color:#24292f">  cell</span><span style="color:#cf222e">.</span><span style="color:#8250df">borrow_mut</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">iter</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">min</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">cloned</span><span style="color:#24292f">(), </span></span>
<span class="line"><span style="color:#24292f">  </span><span style="color:#6e7781">/*   ^^^^^^^^^^ </span></span>
<span class="line"><span style="color:#6e7781">       thread 'main' panicked at 'already borrowed: BorrowMutError'</span></span>
<span class="line"><span style="color:#6e7781">  */</span></span>
<span class="line"><span style="color:#24292f">);</span></span>
<span class="line"></span></code></pre></div></code></pre><p>äºæ˜¯å°±åƒäº†ä¸€ä¸ª panicã€‚å°½ç®¡ç”¨é€—å·éš”å¼€äº†ï¼Œä½†<strong>è¡¨è¾¾å¼é‡Œé¢çš„ä¸´æ—¶å˜é‡ä»ç„¶ä¼šç”Ÿå­˜åˆ°è¡¨è¾¾å¼çš„ç»“æŸ</strong>ï¼Œå‡½æ•°è°ƒç”¨çš„å®å‚åŒç†ã€‚è€ƒè™‘ä¸‹é¢ä¸€ä¸ªç®€å•çš„ä¾‹å­å°±çŸ¥é“ä¸ºä»€ä¹ˆè¦è¿™æ ·äº†ï¼š</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#282c34"><code><span class="line"><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">mut</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">i</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#d19a66">42</span><span style="color:#abb2bf">;</span></span>
<span class="line"><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">tuple</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> (&amp;</span><span style="color:#e06c75">i</span><span style="color:#abb2bf">, &amp;</span><span style="color:#c678dd">mut</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">i</span><span style="color:#abb2bf">);</span><span style="color:#7f848e;font-style:italic"> // æ˜¾ç„¶ä¸è¡Œå§</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#cf222e">let</span><span style="color:#24292f"> </span><span style="color:#cf222e">mut</span><span style="color:#24292f"> i </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#0550ae">42</span><span style="color:#24292f">;</span></span>
<span class="line"><span style="color:#cf222e">let</span><span style="color:#24292f"> tuple </span><span style="color:#cf222e">=</span><span style="color:#24292f"> (</span><span style="color:#cf222e">&amp;</span><span style="color:#24292f">i, </span><span style="color:#cf222e">&amp;mut</span><span style="color:#24292f"> i);</span><span style="color:#6e7781"> // æ˜¾ç„¶ä¸è¡Œå§</span></span>
<span class="line"></span></code></pre></div></code></pre><p><s>å¤§å®¶æœ€å–œæ¬¢çš„</s> C++ ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼š</p><pre><code class="language-cpp"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#282c34"><code><span class="line"><span style="color:#c678dd">#include</span><span style="color:#abb2bf"> </span><span style="color:#98c379">&lt;iostream&gt;</span></span>
<span class="line"><span style="color:#c678dd">#include</span><span style="color:#abb2bf"> </span><span style="color:#98c379">&lt;tuple&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c678dd">struct</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">A</span><span style="color:#abb2bf"> {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">int</span><span style="color:#abb2bf"> v;</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#61afef">A</span><span style="color:#abb2bf">(</span><span style="color:#c678dd">int</span><span style="color:#abb2bf"> </span><span style="color:#e06c75;font-style:italic">i</span><span style="color:#abb2bf">): </span><span style="color:#61afef">v</span><span style="color:#abb2bf">(i) {</span></span>
<span class="line"><span style="color:#abb2bf">        std::cout </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> </span><span style="color:#98c379">"A("</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> i </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> </span><span style="color:#98c379">")"</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> std::endl;</span></span>
<span class="line"><span style="color:#abb2bf">    }</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#61afef">~A</span><span style="color:#abb2bf">() {</span></span>
<span class="line"><span style="color:#abb2bf">        std::cout </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> </span><span style="color:#98c379">"~A("</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> v </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> </span><span style="color:#98c379">")"</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> std::endl;</span></span>
<span class="line"><span style="color:#abb2bf">    }</span></span>
<span class="line"><span style="color:#abb2bf">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c678dd">int</span><span style="color:#abb2bf"> </span><span style="color:#61afef">main</span><span style="color:#abb2bf">() {</span></span>
<span class="line"><span style="color:#abb2bf">    std::tuple</span><span style="color:#c678dd">&lt;</span><span style="color:#abb2bf">A, A</span><span style="color:#c678dd">&gt;</span><span style="color:#abb2bf"> t </span><span style="color:#c678dd">=</span><span style="color:#abb2bf"> {</span><span style="color:#61afef">A</span><span style="color:#abb2bf">(</span><span style="color:#d19a66">1</span><span style="color:#abb2bf">), </span><span style="color:#61afef">A</span><span style="color:#abb2bf">(</span><span style="color:#d19a66">2</span><span style="color:#abb2bf">)};</span></span>
<span class="line"><span style="color:#7f848e;font-style:italic">  	/*</span></span>
<span class="line"><span style="color:#7f848e;font-style:italic">  	                      A(1)</span></span>
<span class="line"><span style="color:#7f848e;font-style:italic">  	                            A(2)</span></span>
<span class="line"><span style="color:#7f848e;font-style:italic">  	                           ~A(2)</span></span>
<span class="line"><span style="color:#7f848e;font-style:italic">  	                     ~A(1)</span></span>
<span class="line"><span style="color:#7f848e;font-style:italic">  	*/</span></span>
<span class="line"><span style="color:#abb2bf">    std::cout </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> </span><span style="color:#98c379">"---"</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> std::endl;</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#cf222e">#include</span><span style="color:#24292f"> </span><span style="color:#0a3069">&lt;iostream&gt;</span></span>
<span class="line"><span style="color:#cf222e">#include</span><span style="color:#24292f"> </span><span style="color:#0a3069">&lt;tuple&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">struct</span><span style="color:#24292f"> </span><span style="color:#953800">A</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">int</span><span style="color:#24292f"> v;</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">A</span><span style="color:#24292f">(</span><span style="color:#cf222e">int</span><span style="color:#24292f"> </span><span style="color:#953800">i</span><span style="color:#24292f">): </span><span style="color:#8250df">v</span><span style="color:#24292f">(i) {</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#953800">std</span><span style="color:#24292f">::cout </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> </span><span style="color:#0a3069">"A("</span><span style="color:#24292f"> </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> i </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> </span><span style="color:#0a3069">")"</span><span style="color:#24292f"> </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> </span><span style="color:#953800">std</span><span style="color:#24292f">::endl;</span></span>
<span class="line"><span style="color:#24292f">    }</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">~A</span><span style="color:#24292f">() {</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#953800">std</span><span style="color:#24292f">::cout </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> </span><span style="color:#0a3069">"~A("</span><span style="color:#24292f"> </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> v </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> </span><span style="color:#0a3069">")"</span><span style="color:#24292f"> </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> </span><span style="color:#953800">std</span><span style="color:#24292f">::endl;</span></span>
<span class="line"><span style="color:#24292f">    }</span></span>
<span class="line"><span style="color:#24292f">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">int</span><span style="color:#24292f"> </span><span style="color:#8250df">main</span><span style="color:#24292f">() {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">std</span><span style="color:#24292f">::tuple</span><span style="color:#cf222e">&lt;</span><span style="color:#24292f">A, A</span><span style="color:#cf222e">&gt;</span><span style="color:#24292f"> t </span><span style="color:#cf222e">=</span><span style="color:#24292f"> {</span><span style="color:#8250df">A</span><span style="color:#24292f">(</span><span style="color:#0550ae">1</span><span style="color:#24292f">), </span><span style="color:#8250df">A</span><span style="color:#24292f">(</span><span style="color:#0550ae">2</span><span style="color:#24292f">)};</span></span>
<span class="line"><span style="color:#6e7781">  	/*</span></span>
<span class="line"><span style="color:#6e7781">  	                      A(1)</span></span>
<span class="line"><span style="color:#6e7781">  	                            A(2)</span></span>
<span class="line"><span style="color:#6e7781">  	                           ~A(2)</span></span>
<span class="line"><span style="color:#6e7781">  	                     ~A(1)</span></span>
<span class="line"><span style="color:#6e7781">  	*/</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">std</span><span style="color:#24292f">::cout </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> </span><span style="color:#0a3069">"---"</span><span style="color:#24292f"> </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> </span><span style="color:#953800">std</span><span style="color:#24292f">::endl;</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span></code></pre></div></code></pre><p>æ‰€ä»¥åªå¥½ä¹–ä¹–åœ°åŠ ä¸€ä¸ªä¸­é—´å˜é‡ï¼š</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#282c34"><code><span class="line"><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">r</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">cell</span><span style="color:#abb2bf">.</span><span style="color:#61afef">borrow_mut</span><span style="color:#abb2bf">();</span></span>
<span class="line"><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">values</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> (</span><span style="color:#e06c75">r</span><span style="color:#abb2bf">.</span><span style="color:#61afef">iter</span><span style="color:#abb2bf">().</span><span style="color:#61afef">max</span><span style="color:#abb2bf">().</span><span style="color:#61afef">cloned</span><span style="color:#abb2bf">(), </span><span style="color:#e06c75">r</span><span style="color:#abb2bf">.</span><span style="color:#61afef">iter</span><span style="color:#abb2bf">().</span><span style="color:#61afef">min</span><span style="color:#abb2bf">().</span><span style="color:#61afef">cloned</span><span style="color:#abb2bf">());</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#cf222e">let</span><span style="color:#24292f"> r </span><span style="color:#cf222e">=</span><span style="color:#24292f"> cell</span><span style="color:#cf222e">.</span><span style="color:#8250df">borrow_mut</span><span style="color:#24292f">();</span></span>
<span class="line"><span style="color:#cf222e">let</span><span style="color:#24292f"> values </span><span style="color:#cf222e">=</span><span style="color:#24292f"> (r</span><span style="color:#cf222e">.</span><span style="color:#8250df">iter</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">max</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">cloned</span><span style="color:#24292f">(), r</span><span style="color:#cf222e">.</span><span style="color:#8250df">iter</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">min</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">cloned</span><span style="color:#24292f">());</span></span>
<span class="line"></span></code></pre></div></code></pre><p>æˆ–è€…ï¼Œ<s>å†™ä¸€ä¸ªå®</s>ï¼ˆ<code>rust-analyzer</code>ï¼šç¤¼è²Œä½ å—ğŸ¤¬ï¼Ÿï¼‰ï¼š</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#282c34"><code><span class="line"><span style="color:#61afef">macro_rules!</span><span style="color:#abb2bf"> </span><span style="color:#61afef">with</span><span style="color:#abb2bf"> {</span></span>
<span class="line"><span style="color:#abb2bf">    ($</span><span style="color:#e06c75">i</span><span style="color:#abb2bf">:</span><span style="color:#e06c75">ident</span></span>
<span class="line"><span style="color:#abb2bf">      .$($</span><span style="color:#e06c75">h</span><span style="color:#abb2bf">:</span><span style="color:#e06c75">ident</span><span style="color:#abb2bf"> ( $($</span><span style="color:#e06c75">e0</span><span style="color:#abb2bf">:</span><span style="color:#e06c75">expr</span><span style="color:#abb2bf">),*) ).*</span><span style="color:#7f848e;font-style:italic"> // è¦ä¸¢å¼ƒçš„å¯å˜å¼•ç”¨</span></span>
<span class="line"><span style="color:#abb2bf">      #</span></span>
<span class="line"><span style="color:#abb2bf">      .$($</span><span style="color:#e06c75">f</span><span style="color:#abb2bf">:</span><span style="color:#e06c75">ident</span><span style="color:#abb2bf"> ( $($</span><span style="color:#e06c75">e1</span><span style="color:#abb2bf">:</span><span style="color:#e06c75">expr</span><span style="color:#abb2bf">),*) ).*</span><span style="color:#7f848e;font-style:italic"> // è°ƒç”¨é“¾</span></span>
<span class="line"><span style="color:#abb2bf">      $(: $</span><span style="color:#e06c75">ty</span><span style="color:#abb2bf">:</span><span style="color:#e06c75">ty</span><span style="color:#abb2bf">)?</span><span style="color:#7f848e;font-style:italic"> // å¯é€‰çš„ç±»å‹æ ‡æ³¨</span></span>
<span class="line"><span style="color:#abb2bf">    ) =&gt; {</span></span>
<span class="line"><span style="color:#abb2bf">        {</span></span>
<span class="line"><span style="color:#abb2bf">            </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">h</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> $</span><span style="color:#e06c75">i</span><span style="color:#abb2bf">$(.$</span><span style="color:#e06c75">h</span><span style="color:#abb2bf">($($</span><span style="color:#e06c75">e0</span><span style="color:#abb2bf">),*))*;</span></span>
<span class="line"><span style="color:#abb2bf">            </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">v</span><span style="color:#abb2bf">$(: $</span><span style="color:#e06c75">ty</span><span style="color:#abb2bf">)? </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">h</span><span style="color:#abb2bf">$(.$</span><span style="color:#e06c75">f</span><span style="color:#abb2bf">($($</span><span style="color:#e06c75">e1</span><span style="color:#abb2bf">),*))*;</span></span>
<span class="line"><span style="color:#abb2bf">            </span><span style="color:#61afef">drop</span><span style="color:#abb2bf">(</span><span style="color:#e06c75">h</span><span style="color:#abb2bf">);</span></span>
<span class="line"><span style="color:#abb2bf">            </span><span style="color:#e06c75">v</span></span>
<span class="line"><span style="color:#abb2bf">        }</span></span>
<span class="line"><span style="color:#abb2bf">    };</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">cell</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">RefCell</span><span style="color:#abb2bf">::</span><span style="color:#61afef">new</span><span style="color:#abb2bf">(</span><span style="color:#61afef">vec!</span><span style="color:#abb2bf">[</span><span style="color:#d19a66">1</span><span style="color:#abb2bf">, </span><span style="color:#d19a66">2</span><span style="color:#abb2bf">, </span><span style="color:#d19a66">3</span><span style="color:#abb2bf">]);</span></span>
<span class="line"><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">values</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> (</span></span>
<span class="line"><span style="color:#abb2bf">  </span><span style="color:#61afef">with!</span><span style="color:#abb2bf">(</span><span style="color:#e06c75">cell</span></span>
<span class="line"><span style="color:#abb2bf">    .</span><span style="color:#61afef">borrow_mut</span><span style="color:#abb2bf">()</span></span>
<span class="line"><span style="color:#abb2bf">    #</span><span style="color:#7f848e;font-style:italic"> // ä»¥ä¸Šæ˜¯å¯å˜çš„å¼•ç”¨ï¼Œä»¥ä¸‹æ˜¯å¼•ç”¨ä¸Šçš„è°ƒç”¨é“¾</span></span>
<span class="line"><span style="color:#abb2bf">    .</span><span style="color:#61afef">iter</span><span style="color:#abb2bf">()</span></span>
<span class="line"><span style="color:#abb2bf">    .</span><span style="color:#61afef">map</span><span style="color:#abb2bf">(</span><span style="color:#56b6c2">|</span><span style="color:#e06c75">a</span><span style="color:#56b6c2">|</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">a</span><span style="color:#abb2bf"> + </span><span style="color:#d19a66">1</span><span style="color:#abb2bf">)</span></span>
<span class="line"><span style="color:#abb2bf">    .</span><span style="color:#61afef">sum</span><span style="color:#abb2bf">()</span></span>
<span class="line"><span style="color:#abb2bf">    :</span><span style="color:#e5c07b">i32</span><span style="color:#7f848e;font-style:italic"> // å¯é€‰çš„ç±»å‹æ ‡æ³¨</span></span>
<span class="line"><span style="color:#abb2bf">  ),</span></span>
<span class="line"><span style="color:#abb2bf">  </span><span style="color:#61afef">with!</span><span style="color:#abb2bf">(</span><span style="color:#e06c75">cell</span><span style="color:#abb2bf">.</span><span style="color:#61afef">borrow_mut</span><span style="color:#abb2bf">()#.</span><span style="color:#61afef">iter</span><span style="color:#abb2bf">().</span><span style="color:#61afef">max</span><span style="color:#abb2bf">().</span><span style="color:#61afef">cloned</span><span style="color:#abb2bf">()),</span></span>
<span class="line"><span style="color:#abb2bf">  </span><span style="color:#61afef">with!</span><span style="color:#abb2bf">(</span><span style="color:#e06c75">cell</span><span style="color:#abb2bf">.</span><span style="color:#61afef">borrow_mut</span><span style="color:#abb2bf">()#.</span><span style="color:#61afef">iter</span><span style="color:#abb2bf">().</span><span style="color:#61afef">min</span><span style="color:#abb2bf">().</span><span style="color:#61afef">cloned</span><span style="color:#abb2bf">()),</span></span>
<span class="line"><span style="color:#abb2bf">);</span></span>
<span class="line"><span style="color:#61afef">println!</span><span style="color:#abb2bf">(</span><span style="color:#98c379">"{:?}"</span><span style="color:#abb2bf">, </span><span style="color:#e06c75">values</span><span style="color:#abb2bf">);</span><span style="color:#7f848e;font-style:italic"> // -&gt; (9, Some(3), Some(1))</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#8250df">macro_rules!</span><span style="color:#24292f"> </span><span style="color:#8250df">with</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    (</span><span style="color:#cf222e">$</span><span style="color:#24292f">i</span><span style="color:#cf222e">:</span><span style="color:#24292f">ident</span></span>
<span class="line"><span style="color:#24292f">      </span><span style="color:#cf222e">.$</span><span style="color:#24292f">(</span><span style="color:#cf222e">$</span><span style="color:#24292f">h</span><span style="color:#cf222e">:</span><span style="color:#24292f">ident ( </span><span style="color:#cf222e">$</span><span style="color:#24292f">(</span><span style="color:#cf222e">$</span><span style="color:#24292f">e0</span><span style="color:#cf222e">:</span><span style="color:#24292f">expr),</span><span style="color:#cf222e">*</span><span style="color:#24292f">) )</span><span style="color:#cf222e">.*</span><span style="color:#6e7781"> // è¦ä¸¢å¼ƒçš„å¯å˜å¼•ç”¨</span></span>
<span class="line"><span style="color:#24292f">      #</span></span>
<span class="line"><span style="color:#24292f">      </span><span style="color:#cf222e">.$</span><span style="color:#24292f">(</span><span style="color:#cf222e">$</span><span style="color:#24292f">f</span><span style="color:#cf222e">:</span><span style="color:#24292f">ident ( </span><span style="color:#cf222e">$</span><span style="color:#24292f">(</span><span style="color:#cf222e">$</span><span style="color:#24292f">e1</span><span style="color:#cf222e">:</span><span style="color:#24292f">expr),</span><span style="color:#cf222e">*</span><span style="color:#24292f">) )</span><span style="color:#cf222e">.*</span><span style="color:#6e7781"> // è°ƒç”¨é“¾</span></span>
<span class="line"><span style="color:#24292f">      </span><span style="color:#cf222e">$</span><span style="color:#24292f">(</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#cf222e">$</span><span style="color:#24292f">ty</span><span style="color:#cf222e">:</span><span style="color:#24292f">ty)</span><span style="color:#cf222e">?</span><span style="color:#6e7781"> // å¯é€‰çš„ç±»å‹æ ‡æ³¨</span></span>
<span class="line"><span style="color:#24292f">    ) </span><span style="color:#cf222e">=&gt;</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">        {</span></span>
<span class="line"><span style="color:#24292f">            </span><span style="color:#cf222e">let</span><span style="color:#24292f"> h </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#cf222e">$</span><span style="color:#24292f">i</span><span style="color:#cf222e">$</span><span style="color:#24292f">(</span><span style="color:#cf222e">.$</span><span style="color:#24292f">h(</span><span style="color:#cf222e">$</span><span style="color:#24292f">(</span><span style="color:#cf222e">$</span><span style="color:#24292f">e0),</span><span style="color:#cf222e">*</span><span style="color:#24292f">))</span><span style="color:#cf222e">*</span><span style="color:#24292f">;</span></span>
<span class="line"><span style="color:#24292f">            </span><span style="color:#cf222e">let</span><span style="color:#24292f"> v</span><span style="color:#cf222e">$</span><span style="color:#24292f">(</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#cf222e">$</span><span style="color:#24292f">ty)</span><span style="color:#cf222e">?</span><span style="color:#24292f"> </span><span style="color:#cf222e">=</span><span style="color:#24292f"> h</span><span style="color:#cf222e">$</span><span style="color:#24292f">(</span><span style="color:#cf222e">.$</span><span style="color:#24292f">f(</span><span style="color:#cf222e">$</span><span style="color:#24292f">(</span><span style="color:#cf222e">$</span><span style="color:#24292f">e1),</span><span style="color:#cf222e">*</span><span style="color:#24292f">))</span><span style="color:#cf222e">*</span><span style="color:#24292f">;</span></span>
<span class="line"><span style="color:#24292f">            </span><span style="color:#8250df">drop</span><span style="color:#24292f">(h);</span></span>
<span class="line"><span style="color:#24292f">            v</span></span>
<span class="line"><span style="color:#24292f">        }</span></span>
<span class="line"><span style="color:#24292f">    };</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">let</span><span style="color:#24292f"> cell </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">RefCell</span><span style="color:#cf222e">::</span><span style="color:#8250df">new</span><span style="color:#24292f">(</span><span style="color:#8250df">vec!</span><span style="color:#24292f">[</span><span style="color:#0550ae">1</span><span style="color:#24292f">, </span><span style="color:#0550ae">2</span><span style="color:#24292f">, </span><span style="color:#0550ae">3</span><span style="color:#24292f">]);</span></span>
<span class="line"><span style="color:#cf222e">let</span><span style="color:#24292f"> values </span><span style="color:#cf222e">=</span><span style="color:#24292f"> (</span></span>
<span class="line"><span style="color:#24292f">  </span><span style="color:#8250df">with!</span><span style="color:#24292f">(cell</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">.</span><span style="color:#8250df">borrow_mut</span><span style="color:#24292f">()</span></span>
<span class="line"><span style="color:#24292f">    #</span><span style="color:#6e7781"> // ä»¥ä¸Šæ˜¯å¯å˜çš„å¼•ç”¨ï¼Œä»¥ä¸‹æ˜¯å¼•ç”¨ä¸Šçš„è°ƒç”¨é“¾</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">.</span><span style="color:#8250df">iter</span><span style="color:#24292f">()</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">.</span><span style="color:#8250df">map</span><span style="color:#24292f">(</span><span style="color:#cf222e">|</span><span style="color:#24292f">a</span><span style="color:#cf222e">|</span><span style="color:#24292f"> a </span><span style="color:#cf222e">+</span><span style="color:#24292f"> </span><span style="color:#0550ae">1</span><span style="color:#24292f">)</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">.</span><span style="color:#8250df">sum</span><span style="color:#24292f">()</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">:</span><span style="color:#953800">i32</span><span style="color:#6e7781"> // å¯é€‰çš„ç±»å‹æ ‡æ³¨</span></span>
<span class="line"><span style="color:#24292f">  ),</span></span>
<span class="line"><span style="color:#24292f">  </span><span style="color:#8250df">with!</span><span style="color:#24292f">(cell</span><span style="color:#cf222e">.</span><span style="color:#8250df">borrow_mut</span><span style="color:#24292f">()#</span><span style="color:#cf222e">.</span><span style="color:#8250df">iter</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">max</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">cloned</span><span style="color:#24292f">()),</span></span>
<span class="line"><span style="color:#24292f">  </span><span style="color:#8250df">with!</span><span style="color:#24292f">(cell</span><span style="color:#cf222e">.</span><span style="color:#8250df">borrow_mut</span><span style="color:#24292f">()#</span><span style="color:#cf222e">.</span><span style="color:#8250df">iter</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">min</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">cloned</span><span style="color:#24292f">()),</span></span>
<span class="line"><span style="color:#24292f">);</span></span>
<span class="line"><span style="color:#8250df">println!</span><span style="color:#24292f">(</span><span style="color:#0a3069">"{:?}"</span><span style="color:#24292f">, values);</span><span style="color:#6e7781"> // -&gt; (9, Some(3), Some(1))</span></span>
<span class="line"></span></code></pre></div></code></pre><hr class="talk-separator"><h2 id="è¿”å›å€¼ä½ç½®çš„-impl-trait" tabindex="-1">è¿”å›å€¼ä½ç½®çš„ <code>impl Trait</code></h2><p>æ¥è‡ª <a href="https://this-week-in-rust.org/blog/2022/05/18/this-week-in-rust-443/" target="_blank" rel="noopener">This Week in Rust 443</a> æ¨èæ–‡ç«  <a href="https://davidkoloski.me/blog/a-new-impl-trait-1/#citation-2" target="_blank" rel="noopener"><em>A new impl Trait 1/4</em></a>ã€‚</p><p><s>ä¼—æ‰€å‘¨çŸ¥</s>ï¼Œ<code>impl Trait</code> åœ¨å½¢å‚ä½ç½®å’Œè¿”å›å€¼ä½ç½®æ˜¯å®Œå…¨ä¸åŒçš„è¯­æ³•ç³–ğŸ¤¯ã€‚åœ¨è¿”å›å€¼ä½ç½®ï¼Œå¯ä»¥ç†è§£ä¸ºå®ƒè¡¨ç¤ºä¸€ä¸ªâ€œ<strong>é™æ€çš„æŠ½è±¡ç±»å‹ğŸ˜</strong>â€ï¼Œå³ï¼š</p><ul><li>ç¼–è¯‘å™¨åœ¨<strong>ç¼–è¯‘æœŸ</strong>ä¸ºå®ƒç¡®å®šäº†ä¸€ä¸ªå…·ä½“ç±»å‹ï¼Œæ‰€ä»¥<em>ä»ç„¶æ˜¯é™æ€æ´¾å‘</em>ã€‚</li><li>ä½†å®ƒæ˜¯ä¸€ä¸ª<strong>æŠ½è±¡ç±»å‹</strong>ï¼ˆ<a href="https://en.wikipedia.org/wiki/Abstract_type" target="_blank" rel="noopener">abstract type</a>ï¼‰ã€‚åœ¨è¯­ä¹‰ä¸Šï¼Œå®ƒ<em>å®ç°ä¸”ä»…å®ç°</em>äº† <code>Trait</code> æš´éœ²å‡ºæ¥çš„æ¥å£ã€‚</li></ul><p><code>impl Trait</code> ä¸€èˆ¬ç”¨äºå¸¦æœ‰å…³è”ç±»å‹ï¼ˆassociate typeï¼‰çš„ç‰¹å¾ï¼Œæ¯”å¦‚ <code>Iterator</code> æˆ–æ˜¯ <code>Future</code>ï¼Œå®ƒä»¬çš„å…³è”ç±»å‹å¯èƒ½å˜å¾—éå¸¸å¤æ‚ï¼Œæ‰€ä»¥ç”¨ <code>impl</code> æŠ½è±¡å®ƒçœç•¥æ‰è¿™äº›ç±»å‹ä¼šæ¯”è¾ƒæ–¹ä¾¿ã€‚éšå¼çš„æ¨æ–­å›ºç„¶æ–¹ä¾¿ï¼Œä½†æœ€ç»ˆæ¨æ–­å‡ºäº†ä»€ä¹ˆç±»å‹ï¼Ÿè¿™é‡Œé¢å°±æœ‰å¯èƒ½â€¦â€¦ğŸ˜ˆ</p><p>æ¯”å¦‚åšæ–‡ä¸­ä¸¾å‡ºçš„è¿™ä¸ªä¾‹å­ï¼š</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#282c34"><code><span class="line"><span style="color:#c678dd">trait</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Ore</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">Clone</span><span style="color:#abb2bf"> {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">fn</span><span style="color:#abb2bf"> </span><span style="color:#61afef">print</span><span style="color:#abb2bf">(&amp;</span><span style="color:#e5c07b">self</span><span style="color:#abb2bf">);</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c678dd">impl</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">Ore</span><span style="color:#abb2bf">&gt; </span><span style="color:#e5c07b">Ore</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">for</span><span style="color:#abb2bf"> &amp;</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf"> {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">fn</span><span style="color:#abb2bf"> </span><span style="color:#61afef">print</span><span style="color:#abb2bf">(&amp;</span><span style="color:#e5c07b">self</span><span style="color:#abb2bf">) { </span><span style="color:#61afef">println!</span><span style="color:#abb2bf">(</span><span style="color:#98c379">"Ore"</span><span style="color:#abb2bf">); }</span><span style="color:#7f848e;font-style:italic"> // &lt;- print#1</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#abb2bf">#[derive(</span><span style="color:#e5c07b">Clone</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">Copy</span><span style="color:#abb2bf">)]</span></span>
<span class="line"><span style="color:#c678dd">struct</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Bauxite</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic"> // é“åœŸçŸ¿ï¼ˆè¯è¯´è¿™ä¸ªåšä¸»æ€ä¹ˆè¿™ä¹ˆå–œæ¬¢æŒ–çŸ¿å•Šï¼‰</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c678dd">impl</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Ore</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">for</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Bauxite</span><span style="color:#abb2bf"> {</span><span style="color:#7f848e;font-style:italic"> // &lt;- Bauxite ä¸Šå®ç°äº† Cloneï¼ŒOK</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">fn</span><span style="color:#abb2bf"> </span><span style="color:#61afef">print</span><span style="color:#abb2bf">(&amp;</span><span style="color:#e5c07b">self</span><span style="color:#abb2bf">) { </span><span style="color:#61afef">println!</span><span style="color:#abb2bf">(</span><span style="color:#98c379">"Bauxite"</span><span style="color:#abb2bf">); }</span><span style="color:#7f848e;font-style:italic"> // &lt;- print#2</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c678dd">struct</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Quarry</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">&gt; {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">ore</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">,</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c678dd">impl</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">Ore</span><span style="color:#abb2bf">&gt; </span><span style="color:#e5c07b">Quarry</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">&gt; {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">fn</span><span style="color:#abb2bf"> </span><span style="color:#61afef">ore</span><span style="color:#abb2bf">(&amp;</span><span style="color:#e5c07b">self</span><span style="color:#abb2bf">) -&gt; &amp;</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf"> {</span></span>
<span class="line"><span style="color:#abb2bf">        &amp;</span><span style="color:#e5c07b">self</span><span style="color:#abb2bf">.ore</span></span>
<span class="line"><span style="color:#abb2bf">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">fn</span><span style="color:#abb2bf"> </span><span style="color:#61afef">mine</span><span style="color:#abb2bf">(&amp;</span><span style="color:#e5c07b">self</span><span style="color:#abb2bf">) -&gt; </span><span style="color:#c678dd">impl</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Ore</span><span style="color:#abb2bf"> + '</span><span style="color:#e5c07b">_</span><span style="color:#abb2bf"> {</span><span style="color:#7f848e;font-style:italic"> // &lt;- è¿™é‡Œæœ‰ä¸€ä¸ª**å¾ˆå¯ç–‘**çš„éšå¼ç”Ÿå‘½å‘¨æœŸ</span></span>
<span class="line"><span style="color:#abb2bf">        </span><span style="color:#e5c07b">self</span><span style="color:#abb2bf">.</span><span style="color:#61afef">ore</span><span style="color:#abb2bf">().</span><span style="color:#61afef">clone</span><span style="color:#abb2bf">()</span></span>
<span class="line"><span style="color:#abb2bf">    }</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#abb2bf">#[test]</span></span>
<span class="line"><span style="color:#c678dd">fn</span><span style="color:#abb2bf"> </span><span style="color:#61afef">test_impl</span><span style="color:#abb2bf">() {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">quarry</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Quarry</span><span style="color:#abb2bf"> { </span><span style="color:#e06c75">ore</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">Bauxite</span><span style="color:#abb2bf"> };</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">quarry</span><span style="color:#abb2bf">.</span><span style="color:#61afef">mine</span><span style="color:#abb2bf">().</span><span style="color:#61afef">print</span><span style="color:#abb2bf">();</span><span style="color:#7f848e;font-style:italic"> // &gt;&gt; Bauxite</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#cf222e">trait</span><span style="color:#24292f"> </span><span style="color:#953800">Ore</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">Clone</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">fn</span><span style="color:#24292f"> </span><span style="color:#8250df">print</span><span style="color:#24292f">(</span><span style="color:#cf222e">&amp;</span><span style="color:#0550ae">self</span><span style="color:#24292f">);</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">impl</span><span style="color:#24292f">&lt;</span><span style="color:#953800">T</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">Ore</span><span style="color:#24292f">&gt; </span><span style="color:#953800">Ore</span><span style="color:#24292f"> </span><span style="color:#cf222e">for</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;</span><span style="color:#953800">T</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">fn</span><span style="color:#24292f"> </span><span style="color:#8250df">print</span><span style="color:#24292f">(</span><span style="color:#cf222e">&amp;</span><span style="color:#0550ae">self</span><span style="color:#24292f">) { </span><span style="color:#8250df">println!</span><span style="color:#24292f">(</span><span style="color:#0a3069">"Ore"</span><span style="color:#24292f">); }</span><span style="color:#6e7781"> // &lt;- print#1</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">#[derive(</span><span style="color:#953800">Clone</span><span style="color:#24292f">, </span><span style="color:#953800">Copy</span><span style="color:#24292f">)]</span></span>
<span class="line"><span style="color:#cf222e">struct</span><span style="color:#24292f"> </span><span style="color:#953800">Bauxite</span><span style="color:#24292f">;</span><span style="color:#6e7781"> // é“åœŸçŸ¿ï¼ˆè¯è¯´è¿™ä¸ªåšä¸»æ€ä¹ˆè¿™ä¹ˆå–œæ¬¢æŒ–çŸ¿å•Šï¼‰</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">impl</span><span style="color:#24292f"> </span><span style="color:#953800">Ore</span><span style="color:#24292f"> </span><span style="color:#cf222e">for</span><span style="color:#24292f"> </span><span style="color:#953800">Bauxite</span><span style="color:#24292f"> {</span><span style="color:#6e7781"> // &lt;- Bauxite ä¸Šå®ç°äº† Cloneï¼ŒOK</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">fn</span><span style="color:#24292f"> </span><span style="color:#8250df">print</span><span style="color:#24292f">(</span><span style="color:#cf222e">&amp;</span><span style="color:#0550ae">self</span><span style="color:#24292f">) { </span><span style="color:#8250df">println!</span><span style="color:#24292f">(</span><span style="color:#0a3069">"Bauxite"</span><span style="color:#24292f">); }</span><span style="color:#6e7781"> // &lt;- print#2</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">struct</span><span style="color:#24292f"> </span><span style="color:#953800">Quarry</span><span style="color:#24292f">&lt;</span><span style="color:#953800">T</span><span style="color:#24292f">&gt; {</span></span>
<span class="line"><span style="color:#24292f">    ore</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">T</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">impl</span><span style="color:#24292f">&lt;</span><span style="color:#953800">T</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">Ore</span><span style="color:#24292f">&gt; </span><span style="color:#953800">Quarry</span><span style="color:#24292f">&lt;</span><span style="color:#953800">T</span><span style="color:#24292f">&gt; {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">fn</span><span style="color:#24292f"> </span><span style="color:#8250df">ore</span><span style="color:#24292f">(</span><span style="color:#cf222e">&amp;</span><span style="color:#0550ae">self</span><span style="color:#24292f">) </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;</span><span style="color:#953800">T</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#cf222e">&amp;</span><span style="color:#0550ae">self</span><span style="color:#cf222e">.</span><span style="color:#24292f">ore</span></span>
<span class="line"><span style="color:#24292f">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">fn</span><span style="color:#24292f"> </span><span style="color:#8250df">mine</span><span style="color:#24292f">(</span><span style="color:#cf222e">&amp;</span><span style="color:#0550ae">self</span><span style="color:#24292f">) </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> </span><span style="color:#cf222e">impl</span><span style="color:#24292f"> </span><span style="color:#953800">Ore</span><span style="color:#24292f"> </span><span style="color:#cf222e">+</span><span style="color:#24292f"> '</span><span style="color:#953800">_</span><span style="color:#24292f"> {</span><span style="color:#6e7781"> // &lt;- è¿™é‡Œæœ‰ä¸€ä¸ª**å¾ˆå¯ç–‘**çš„éšå¼ç”Ÿå‘½å‘¨æœŸ</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#0550ae">self</span><span style="color:#cf222e">.</span><span style="color:#8250df">ore</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">clone</span><span style="color:#24292f">()</span></span>
<span class="line"><span style="color:#24292f">    }</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">#[test]</span></span>
<span class="line"><span style="color:#cf222e">fn</span><span style="color:#24292f"> </span><span style="color:#8250df">test_impl</span><span style="color:#24292f">() {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> quarry </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">Quarry</span><span style="color:#24292f"> { ore</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">Bauxite</span><span style="color:#24292f"> };</span></span>
<span class="line"><span style="color:#24292f">    quarry</span><span style="color:#cf222e">.</span><span style="color:#8250df">mine</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">print</span><span style="color:#24292f">();</span><span style="color:#6e7781"> // &gt;&gt; Bauxite</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span></code></pre></div></code></pre><p>è¾“å‡ºäº† Bauxiteï¼Œè¯´æ˜ <code>impl</code> æ¨æ–­å‡ºæ¥çš„å…·ä½“ç±»å‹æ˜¯ <code>Bauxite</code>ï¼Œæ´¾å‘åˆ°äº† <code>print#2</code>ï¼Œä¸€åˆ‡æ­£å¸¸ğŸ¤”ã€‚</p><p>ä½†ï¼Œå½“ä½ åˆ é™¤äº†ç¬¬ä¸€è¡Œ <code>Clone</code> çš„çº¦æŸåï¼Œæ‰“å°å‡ºæ¥çš„å°±å˜æˆäº† Oreï¼Œæ´¾å‘åˆ°äº† <code>print#1</code>ğŸ˜²ã€‚ä¸ºä»€ä¹ˆï¼Ÿæ³¨æ„ <code>impl</code> åé¢é‚£ä¸ªå¯ç–‘çš„éšå¼ç”Ÿå‘½å‘¨æœŸâ€¦â€¦</p><p>åœ¨ <code>mine()</code> ä¸­ï¼Œ<code>self.ore()</code> çš„ç±»å‹æ˜¯ <code>&amp;T</code>ï¼Œè€Œ <code>T</code> æ»¡è¶³ <code>Ore</code>â€¦â€¦</p><ul><li>å¦‚æœ <code>Ore</code> åŒæ—¶æ»¡è¶³ <code>Clone</code>ï¼Œé‚£ä¹ˆæ ¹æ® <a href="https://doc.rust-lang.org/std/ops/trait.Deref.html" target="_blank" rel="noopener"><code>Deref</code></a> è¯­æ³•ç³–ï¼Œ<code>&amp;T.clone()</code> è°ƒç”¨çš„å°±æ˜¯ <code>&lt;T as Clone&gt;::clone</code>ï¼Œå¾—åˆ°ä¸€ä¸ª <code>T</code>ï¼›</li><li>å¦‚æœ <code>Ore</code> ä¸æ»¡è¶³ <code>Clone</code>ï¼Œé‚£ä¹ˆè°ƒç”¨çš„å°±æ˜¯ <code>&lt;&amp;T as Clone&gt;::clone</code>ï¼Œå¾—åˆ°ä¸€ä¸ª <code>&amp;T</code>ã€‚</li></ul><p>æ³¨æ„ï¼Œåœ¨è¿™ä¸ªå®ç°å—é‡Œï¼Œå¹¶æ²¡æœ‰åœ¨ <code>T</code> ä¸Šçº¦æŸ <code>Clone</code>ï¼Œå³ä½¿ <code>Bauxite</code> å®ç°äº† <code>Clone</code> ä¹Ÿä¼šè¢«å¿½ç•¥ã€‚<code>mine()</code> çš„è¿”å›å€¼æ˜¯ä¸€ä¸ª <code>impl Ore</code>ï¼Œæ‰€ä»¥â€¦â€¦</p><ul><li>å¦‚æœè¿”å›å€¼æ˜¯ <code>T</code>ï¼Œè€Œåœ¨å®ç°å—é‡Œçº¦æŸäº† <code>T</code> å®ç° <code>Ore</code>ï¼Œ<code>T</code> å¯ä»¥æŠ½è±¡ä¸º <code>impl Ore</code>ï¼›</li><li>å¦‚æœè¿”å›å€¼æ˜¯ <code>&amp;T</code>ï¼Œå®ç°å—é‡Œçº¦æŸäº† <code>T</code> å®ç° <code>Ore</code>ï¼Œè€Œ<s>è¯¡è®¡å¤šç«¯çš„</s> <code>Ore</code> å£°æ˜ï¼šå¯¹æ‰€æœ‰å®ç°äº† <code>Ore</code> çš„ <code>T</code>ï¼Œ<code>&amp;T</code> ä¹Ÿå®ç° <code>Ore</code>ï¼æ‰€ä»¥ <code>&amp;T</code> ä¹Ÿå¯ä»¥æŠ½è±¡ä¸º <code>impl Ore</code>ã€‚</li></ul><p>å¦‚æœè¿”å›å€¼ä¸ç”¨ <code>impl</code>ï¼Œé‚£ä¹ˆè¿”å› <code>&amp;T</code> å…¶å®ç¬¦åˆç”Ÿå‘½å‘¨æœŸæ“¦é™¤æ¡ä»¶ï¼Œä¸ç”¨æ ‡æ³¨ç”Ÿå‘½å‘¨æœŸã€‚ä½†ç”¨äº† <code>impl</code>ï¼Œæ‰€ä»¥å¿…é¡»åœ¨ <code>impl</code> åé¢åŠ ä¸€ä¸ª <code>'_</code>ã€‚è€Œæ‹¥æœ‰æ‰€æœ‰æƒçš„ <code>T</code> å½“ç„¶ä¹Ÿç¬¦åˆ <code>'_</code>ï¼Œæ‰€ä»¥â€¦â€¦</p><p>ä¸¤ç§æƒ…å†µéƒ½ç¼–è¯‘é€šè¿‡ï¼Œä½†æ´¾å‘åˆ°äº†å®Œå…¨ä¸åŒçš„å®é™…ç±»å‹ğŸ˜µã€‚äº‹å®ä¸Šï¼Œå¦‚æœ <code>Ore</code> åŒæ—¶ä¸º <code>()</code> è‡ªåŠ¨å®ç°ï¼Œè€Œä½ æ‰‹æŠ–å¤šåŠ äº†ä¸€ä¸ªåˆ†å·æŠŠè¿”å›å€¼å˜æˆäº† <code>()</code>ï¼Œä½†ç­¾åé‡Œåˆç”¨äº† <code>impl Ore</code>ï¼Œç¼–è¯‘å®Œç¾é€šè¿‡ï¼Œè¿è¡Œæ—¶å‘ç”Ÿä»€ä¹ˆï¼Œéƒ½ä¸æ•¢æƒ³äº†ğŸ™ƒï¼</p></div></article></article></main></main><!----><!--]--></div><script>window.__INITIAL_STATE__='{"pinia":{}}'</script><script>!function(){var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,a=localStorage.getItem("color-scheme")||"auto",t=(document.documentElement.className="dark"===a||t&&"light"!==a?"dark":"",localStorage.getItem("typesetting::accent_color"));if(t){a=JSON.parse(t),t=Object.entries(a).map(e=>`--accent-${e[0]}: ${e[1]};`).join("\n");let e=document.createElement("style");e.type="text/css",e.innerText=`:root{${t}}`,document.head.appendChild(e)}}()</script><link rel="stylesheet" href="/assets/app.20db8728.css"></body></html>