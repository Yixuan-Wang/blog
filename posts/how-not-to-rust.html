<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon.svg" type="image/svg+xml"><link rel="apple-touch-icon" href="/pwa-192x192.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#00aba9"><meta name="msapplication-TileColor" content="#00aba9"><meta name="theme-color" content="#ffffff"><script type="module" async="" crossorigin="" src="/assets/app.f4861c2d.js"></script><style>button[data-v-adef6890]{padding:.25rem;font-size:1.125rem;line-height:1.75rem;color:var(--color-accent)}button[data-v-adef6890]:hover{color:var(--color-secondary)}#app{display:grid;grid-template-rows:auto 1fr auto;grid-template-columns:100%;margin-left:1rem;margin-right:1rem;height:100%}@media (min-width:1024px){#app{margin-left:0;margin-right:0}}*,:after,:before{box-sizing:border-box;border-width:0;border-style:solid;border-color:currentColor}html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji"}body{margin:0;line-height:inherit}h1,h2{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}strong{font-weight:bolder}code,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-size:1em}button{font-family:inherit;font-size:100%;line-height:inherit;color:inherit;margin:0;padding:0}button{text-transform:none}button{-webkit-appearance:button;background-color:transparent;background-image:none}blockquote,h1,h2,p,pre{margin:0}ul{list-style:none;margin:0;padding:0}button{cursor:pointer}*,::after,::before{--un-rotate:0;--un-rotate-x:0;--un-rotate-y:0;--un-rotate-z:0;--un-scale-x:1;--un-scale-y:1;--un-scale-z:1;--un-skew-x:0;--un-skew-y:0;--un-translate-x:0;--un-translate-y:0;--un-translate-z:0;--un-scroll-snap-strictness:proximity;--un-border-spacing-x:0;--un-border-spacing-y:0;--un-ring-offset-shadow:0 0 rgba(0,0,0,0);--un-ring-shadow:0 0 rgba(0,0,0,0);--un-shadow:0 0 rgba(0,0,0,0);--un-ring-offset-width:0px;--un-ring-offset-color:#fff;--un-ring-width:0px;--un-ring-color:rgba(147,197,253,0.5)}.i-mdi-file,[i-mdi-file=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg preserveAspectRatio='xMidYMid meet' viewBox='0 0 24 24' display='inline-block' vertical-align='sub' width='1.25em' height='1.25em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M13 9V3.5L18.5 9M6 2c-1.11 0-2 .89-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6H6Z'/%3E%3C/svg%3E");mask:var(--un-icon) no-repeat;mask-size:100% 100%;-webkit-mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;background-color:currentColor;display:inline-block;vertical-align:sub;width:1.25em;height:1.25em}[i-mdi-folder=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg preserveAspectRatio='xMidYMid meet' viewBox='0 0 24 24' display='inline-block' vertical-align='sub' width='1.25em' height='1.25em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M10 4H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-8l-2-2Z'/%3E%3C/svg%3E");mask:var(--un-icon) no-repeat;mask-size:100% 100%;-webkit-mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;background-color:currentColor;display:inline-block;vertical-align:sub;width:1.25em;height:1.25em}[i-mdi-table-large=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg preserveAspectRatio='xMidYMid meet' viewBox='0 0 24 24' display='inline-block' vertical-align='sub' width='1.25em' height='1.25em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M4 3h16a2 2 0 0 1 2 2v15a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2m0 4v3h4V7H4m6 0v3h4V7h-4m10 3V7h-4v3h4M4 12v3h4v-3H4m0 8h4v-3H4v3m6-8v3h4v-3h-4m0 8h4v-3h-4v3m10 0v-3h-4v3h4m0-8h-4v3h4v-3Z'/%3E%3C/svg%3E");mask:var(--un-icon) no-repeat;mask-size:100% 100%;-webkit-mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;background-color:currentColor;display:inline-block;vertical-align:sub;width:1.25em;height:1.25em}[i-mdi-text-box=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg preserveAspectRatio='xMidYMid meet' viewBox='0 0 24 24' display='inline-block' vertical-align='sub' width='1.25em' height='1.25em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M14 17H7v-2h7m3-2H7v-2h10m0-2H7V7h10m2-4H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2Z'/%3E%3C/svg%3E");mask:var(--un-icon) no-repeat;mask-size:100% 100%;-webkit-mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;background-color:currentColor;display:inline-block;vertical-align:sub;width:1.25em;height:1.25em}[btn-icon=""]:hover{color:var(--color-accent);transition-duration:.3s;transition-timing-function:cubic-bezier(0,0,.2,1)}.transition-lively,[btn-icon=""],[transition-lively=""]{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:150ms;transition-duration:.2s;transition-timing-function:cubic-bezier(.4,0,1,1)}.transition-lively:hover,[transition-lively=""]:hover{transition-duration:.3s;transition-timing-function:cubic-bezier(0,0,.2,1)}.my-4{margin-top:1rem;margin-bottom:1rem}.mb-8,[m~=b-8]{margin-bottom:2rem}.mt-4,[m~=t-4]{margin-top:1rem}.inline-block{display:inline-block}.flex{display:flex}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-center{align-items:center}.justify-start{justify-content:flex-start}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{grid-gap:.25rem;gap:.25rem}.gap-2{grid-gap:.5rem;gap:.5rem}.gap-3{grid-gap:.75rem;gap:.75rem}.gap-x-1{grid-column-gap:.25rem;column-gap:.25rem}.gap-y-0\.5{grid-row-gap:.125rem;row-gap:.125rem}.rounded{border-radius:.25rem}.hover\:bg-acc:hover,[bg~=acc]{background-color:var(--color-accent)}.hover\:bg-sec:hover,[bg~="hover\:sec"]:hover{background-color:var(--color-secondary)}.p-1{padding:.25rem}.px-2{padding-left:.5rem;padding-right:.5rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.text-left{text-align:left}.font-mono,[font~=mono]{font-family:var(--font-mono)}.text-xs{font-size:.75rem;line-height:1rem}.font-bold,[font~=bold]{font-weight:700}.text-acc{color:var(--color-accent)}.hover\:text-bgd:hover,[text~=bgd]{color:var(--color-background)}.hover\:text-sec:hover,.text-sec{color:var(--color-secondary)}.text-dim{color:var(--color-dim)}[color~="\#00aba9"]{--un-text-opacity:1;color:rgba(0,171,169,var(--un-text-opacity))}:root{--font-sans:"Noto Sans",var(--custom-font-sans, sans-serif),"SF Pro",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Avenir Next","Helvetica Neue",sans-serif;--font-serif:"Noto Serif",var(--custom-font-serif, serif),"Noto Serif","New York","Roboto Slab",Cambria,Georgia,Times,"Times New Roman",serif;--font-mono:"JetBrains Mono","SF Mono","Roboto Mono",Menlo,"Cascadia Code",Consolas,monospace}html:not(.dark){--color-accent:var(--accent-light-accent, #2177B8);--color-secondary:var(--accent-light-secondary, #003A70);--color-background:#F5F5F5;--color-foreground:#1D252D;--color-dim:#737C7B}html{height:100%;width:100%;margin:0;padding:0;text-align:center;font-size:1rem;line-height:1.5rem;overflow-x:hidden;overflow-y:auto;overflow-y:overlay;background-color:var(--color-background);color:var(--color-foreground);font-family:var(--font-sans)}html:not(.dark) .shiki-dark{display:none}body{height:100%;margin:auto;padding:0;max-width:75ch}code,pre{font-family:var(--font-mono)}h1{font-size:1.875rem;line-height:2.25rem;font-weight:700}button{outline:2px solid transparent!important;outline-offset:2px!important}#md a,#md a *{text-decoration-skip-ink:auto;color:var(--color-accent);transition:all .2s ease-in}#md a :hover,#md a:hover{color:var(--color-secondary);transition:all .3s ease-out}#md em{padding-right:.25ch}#md h2{margin:1.25em 0 .75em;font-family:var(--font-serif);font-weight:700}#md h2{font-size:1.5em}#md p{margin:1em 0}#md h2:first-child,#md p:first-child,#md pre:first-child{margin-top:0}#md h2:last-child,#md p:last-child,#md pre:last-child{margin-bottom:0}#md a{text-decoration:underline;text-decoration-skip-ink:auto}#md blockquote{border-left:4px solid var(--color-foreground);padding-left:1em;margin-left:0;margin-top:0}#md blockquote p{margin-bottom:0}#md pre pre{border-radius:.25rem;padding:1em;max-width:100%;overflow:auto}#md p code{font-size:.95rem;padding:.2em}#md code,#md pre{font-family:var(--font-mono);line-height:154%}#md pre{margin:1em 0}</style><link rel="preload" href="/assets/app.f386ae20.css" as="style"><link rel="modulepreload" crossorigin="" href="/assets/pl_how-not-to-rust.a141b90e.js"><link rel="modulepreload" crossorigin="" href="/assets/TheArticle.f1c4b061.js"><title>How NOT to Rust è®²åº§ç¬”è®° | Pak</title><meta name="description" content="TUNA è®²åº§ How NOT to Rust çš„ç®€å•ç¬”è®°ï¼Œä½œä¸ºç§è‰ Rust çš„çºªå¿µã€‚"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css" integrity="sha384-zTROYFVGOfTw7JV7KUu8udsvW2fx4lWOsCEDqhBreBwlHI4ioVRtmIvEThzJHGET" crossorigin="anonymous"><meta name="head:count" content="2"></head><body><div id="app" data-server-rendered="true"><!--[--><header class="flex justify-between items-center my-4 gap-2" data-v-adef6890=""><nav class="inline-block px-2 py-1 rounded transition-lively" text="bgd" bg="acc hover:sec" font="mono bold" data-v-adef6890=""><a href="/" class="" data-v-adef6890="">pÎ±k</a></nav><nav class="flex justify-between items-center gap-3" data-v-adef6890=""><button transition-lively="" class="hover:text-sec" data-v-adef6890=""><a href="/archive" class="" data-v-adef6890=""><div i-mdi-text-box="" data-v-adef6890=""></div></a></button><button transition-lively="" class="hover:text-sec" data-v-adef6890=""><a href="/posts" class="" data-v-adef6890=""><div i-mdi-file="" data-v-adef6890=""></div></a></button><button transition-lively="" class="hover:text-sec" data-v-adef6890=""><a href="/sheets" class="" data-v-adef6890=""><div i-mdi-table-large="" data-v-adef6890=""></div></a></button><button transition-lively="" class="hover:text-sec" data-v-adef6890=""><a href="/notes" class="" data-v-adef6890=""><div i-mdi-folder="" data-v-adef6890=""></div></a></button></nav></header><main class="text-left"><main class="mb-8"><article class="text-left"><header class="flex flex-col justify-start items-start gap-2 mt-4 mb-8"><h1>How NOT to Rust è®²åº§ç¬”è®°</h1><div class="flex flex-wrap gap-x-1 gap-y-0.5 justify-start items-center"><span class="flex justify-center"><button btn-icon=""><a href="/posts" class=""><div class="i-mdi-file"></div></a></button></span><span class="flex gap-1 justify-center items-center"><span class="inline-block text-xs rounded p-1 font-mono font-bold transition-lively"><!--[--><time>2022/07/10</time><!--]--></span></span><span class="flex gap-1 justify-center items-center"><span class="inline-block text-xs rounded p-1 font-mono font-bold transition-lively text-acc hover:bg-acc hover:text-bgd"><!--[--><a href="/categories/comp" class="">comp</a><!--]--></span></span><span class="flex gap-1 justify-center items-center"><!--[--><span class="inline-block text-xs rounded p-1 font-mono font-bold transition-lively text-sec hover:bg-sec hover:text-bgd"><!--[--><a href="/tags?tag=pl" class=""> @pl</a><!--]--></span><span class="inline-block text-xs rounded p-1 font-mono font-bold transition-lively text-sec hover:bg-sec hover:text-bgd"><!--[--><a href="/tags?tag=rust" class=""> @rust</a><!--]--></span><!--]--></span><span class="flex gap-1 justify-center items-center"><!--[--><span class="inline-block text-xs rounded p-1 font-mono font-bold transition-lively text-dim"><!--[--><span> #salon</span><!--]--></span><!--]--></span></div></header><nav m="t-4 b-8"><ul><!--[--><!--]--></ul></nav><article id="md"><div><p>TUNA è®²åº§ How NOT to Rust çš„ç®€å•ç¬”è®°ï¼Œä½œä¸ºç§è‰ Rust çš„çºªå¿µã€‚</p><!-- more --><p>åŸæ–‡åŠè§†é¢‘è½½ TUNA åšå®¢ï¼š<a href="https://tuna.moe/event/2021/how-not-to-rust/" target="_blank" rel="noopener">é‡‘æªé±¼ä¹‹å¤œï¼šHow NOT to Rust - è¯­è¨€å‘å±•ä¸­çš„å¤±è¯¯å’Œè¡¥æ•‘ä¹‹é€‰é›† | æ¸…åå¤§å­¦ TUNA åä¼š</a>ã€‚</p><h2 id="é•¿åº¦ä¸ºæ³›å‹çš„æ ˆä¸Šåˆ†é…æ•°ç»„" tabindex="-1">é•¿åº¦ä¸ºæ³›å‹çš„æ ˆä¸Šåˆ†é…æ•°ç»„</h2><p>ğŸŸ¢ è§£å†³</p><p>éœ€è¦å¸¸é‡æ³›å‹ï¼ˆconst generics, <a href="https://rust-lang.github.io/rfcs/2000-const-generics.html" target="_blank" rel="noopener">RFC #2000</a>ï¼‰çš„æ”¯æŒã€‚21 å¹´å†¬ï¼Œåœ¨ 1.51 ä¸­<a href="https://blog.rust-lang.org/2021/02/26/const-generics-mvp-beta.html" target="_blank" rel="noopener">å¸¸é‡æ³›å‹ç»ˆäºåƒå‘¼ä¸‡å”¤å§‹å‡ºæ¥</a>ï¼ŒæˆåŠŸå¡«å‘ï¼Œæ ‡å‡†åº“çš„æ–¹æ³•ä¹Ÿä¸å†é™åˆ¶æ ˆä¸Šæ•°ç»„é•¿åº¦å°äºç­‰äº 32 äº†ï¼ˆä¹‹å‰çš„æ•°ç»„çœŸçš„æœ‰åŠæ³•ç”¨å—ï¼Ÿï¼‰ã€‚</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#282c34"><code><span class="line"><span style="color:#c678dd">enum</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">SingleOrArray</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">, </span><span style="color:#c678dd">const</span><span style="color:#abb2bf"> </span><span style="color:#d19a66">N</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">usize</span><span style="color:#abb2bf">&gt; {</span></span>
<span class="line"><span style="color:#abb2bf">  </span><span style="color:#61afef">Single</span><span style="color:#abb2bf">(</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">),</span></span>
<span class="line"><span style="color:#abb2bf">  </span><span style="color:#61afef">Array</span><span style="color:#abb2bf">([</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">; </span><span style="color:#e5c07b">N</span><span style="color:#abb2bf">]),</span><span style="color:#7f848e;font-style:italic"> // &lt;- const generics</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#cf222e">enum</span><span style="color:#24292f"> </span><span style="color:#953800">SingleOrArray</span><span style="color:#24292f">&lt;</span><span style="color:#953800">T</span><span style="color:#24292f">, </span><span style="color:#cf222e">const</span><span style="color:#24292f"> </span><span style="color:#0550ae">N</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">usize</span><span style="color:#24292f">&gt; {</span></span>
<span class="line"><span style="color:#24292f">  </span><span style="color:#8250df">Single</span><span style="color:#24292f">(</span><span style="color:#953800">T</span><span style="color:#24292f">),</span></span>
<span class="line"><span style="color:#24292f">  </span><span style="color:#8250df">Array</span><span style="color:#24292f">([</span><span style="color:#953800">T</span><span style="color:#24292f">; </span><span style="color:#953800">N</span><span style="color:#24292f">]),</span><span style="color:#6e7781"> // &lt;- const generics</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span></code></pre></div></code></pre><p>åœ¨ C++ ä¸­ï¼Œè¿™ä¸ªå¸¸é‡æ³›å‹ï¼Œ<s>ä½ æ›¾è§è¿‡çš„</s>ï¼Œå”¤ä½œæ¨¡æ¿éç±»å‹å½¢å‚ï¼ˆ<a href="https://en.cppreference.com/w/cpp/language/template_parameters#Template_non-type_arguments" target="_blank" rel="noopener">template non-type arguments</a>ï¼‰ï¼š</p><pre><code class="language-cpp"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#282c34"><code><span class="line"><span style="color:#c678dd">template</span><span style="color:#abb2bf">&lt;</span><span style="color:#c678dd">typename</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">, </span><span style="color:#c678dd">size_t</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">N</span><span style="color:#abb2bf">&gt;</span></span>
<span class="line"><span style="color:#c678dd">using</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">single_or_array</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">=</span><span style="color:#abb2bf"> std::</span><span style="color:#e5c07b">variant</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">, std::</span><span style="color:#e5c07b">array</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">N</span><span style="color:#abb2bf">&gt;&gt;;</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#cf222e">template</span><span style="color:#24292f">&lt;</span><span style="color:#cf222e">typename</span><span style="color:#24292f"> </span><span style="color:#953800">T</span><span style="color:#24292f">, </span><span style="color:#cf222e">size_t</span><span style="color:#24292f"> </span><span style="color:#953800">N</span><span style="color:#24292f">&gt;</span></span>
<span class="line"><span style="color:#cf222e">using</span><span style="color:#24292f"> </span><span style="color:#953800">single_or_array</span><span style="color:#24292f"> </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">std</span><span style="color:#24292f">::</span><span style="color:#953800">variant</span><span style="color:#24292f">&lt;</span><span style="color:#953800">T</span><span style="color:#24292f">, </span><span style="color:#953800">std</span><span style="color:#24292f">::</span><span style="color:#953800">array</span><span style="color:#24292f">&lt;</span><span style="color:#953800">T</span><span style="color:#24292f">, </span><span style="color:#953800">N</span><span style="color:#24292f">&gt;&gt;;</span></span>
<span class="line"></span></code></pre></div></code></pre><h2 id="ç‰¹åŒ–" tabindex="-1">ç‰¹åŒ–</h2><p>ğŸŸ  æç½®</p><p>C++ å¯¹ç‰¹åŒ–ï¼ˆspecializationï¼‰çš„æ”¯æŒå¾ˆå¥½ã€‚é™¤äº†æ¨¡æ¿çš„<a href="https://en.cppreference.com/w/cpp/language/template_specialization" target="_blank" rel="noopener">ç‰¹åŒ–</a>å’Œ<a href="https://en.cppreference.com/w/cpp/language/partial_specialization" target="_blank" rel="noopener">åç‰¹åŒ–</a>ï¼Œç‰¹åˆ«åœ°ï¼ŒC++ 20 çš„ <code>concept</code> ä¹Ÿè§„å®šäº†çº¦æŸçš„ååºï¼ˆ<a href="https://en.cppreference.com/w/cpp/language/constraints#Partial_ordering_of_constraints" target="_blank" rel="noopener">partial ordering of constraints</a>ï¼‰ï¼Œä»è€Œæ”¯æŒä»¥ä¸‹ç‰¹åŒ–é­”æ³•ï¼š</p><pre><code class="language-cpp"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#282c34"><code><span class="line"><span style="color:#c678dd">template</span><span style="color:#abb2bf">&lt;</span><span style="color:#c678dd">typename</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">&gt;</span></span>
<span class="line"><span style="color:#c678dd">concept</span><span style="color:#abb2bf"> CanA </span><span style="color:#c678dd">=</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">requires</span><span style="color:#abb2bf">(T t) { </span><span style="color:#e5c07b">t</span><span style="color:#abb2bf">.</span><span style="color:#61afef">a</span><span style="color:#abb2bf">(); };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c678dd">template</span><span style="color:#abb2bf">&lt;</span><span style="color:#c678dd">typename</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">&gt;</span></span>
<span class="line"><span style="color:#c678dd">concept</span><span style="color:#abb2bf"> CanAB </span><span style="color:#c678dd">=</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">requires</span><span style="color:#abb2bf">(T t) { </span><span style="color:#e5c07b">t</span><span style="color:#abb2bf">.</span><span style="color:#61afef">b</span><span style="color:#abb2bf">(); } </span><span style="color:#56b6c2">&amp;&amp;</span><span style="color:#abb2bf"> CanA</span><span style="color:#c678dd">&lt;</span><span style="color:#abb2bf">T</span><span style="color:#c678dd">&gt;</span><span style="color:#abb2bf">;</span></span>
<span class="line"><span style="color:#7f848e;font-style:italic">// CanAB is more SPECIFIC than CanA</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c678dd">struct</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">A</span><span style="color:#abb2bf"> { </span><span style="color:#c678dd">void</span><span style="color:#abb2bf"> </span><span style="color:#61afef">a</span><span style="color:#abb2bf">() {} };</span></span>
<span class="line"><span style="color:#c678dd">struct</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">AB</span><span style="color:#abb2bf">: A { </span><span style="color:#c678dd">void</span><span style="color:#abb2bf"> </span><span style="color:#61afef">b</span><span style="color:#abb2bf">() {} };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c678dd">template</span><span style="color:#abb2bf">&lt;</span><span style="color:#c678dd">CanA</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">&gt;</span></span>
<span class="line"><span style="color:#c678dd">void</span><span style="color:#abb2bf"> </span><span style="color:#61afef">print</span><span style="color:#abb2bf">(</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf"> </span><span style="color:#e06c75;font-style:italic">t</span><span style="color:#abb2bf">) { std::cout </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> </span><span style="color:#98c379">"CanA"</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> std::endl; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c678dd">template</span><span style="color:#abb2bf">&lt;</span><span style="color:#c678dd">CanAB</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">&gt;</span></span>
<span class="line"><span style="color:#c678dd">void</span><span style="color:#abb2bf"> </span><span style="color:#61afef">print</span><span style="color:#abb2bf">(</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf"> </span><span style="color:#e06c75;font-style:italic">t</span><span style="color:#abb2bf">) { std::cout </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> </span><span style="color:#98c379">"CanAB"</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> std::endl; }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#c678dd">int</span><span style="color:#abb2bf"> </span><span style="color:#61afef">main</span><span style="color:#abb2bf">() {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">auto</span><span style="color:#abb2bf"> ab </span><span style="color:#c678dd">=</span><span style="color:#abb2bf"> </span><span style="color:#61afef">AB</span><span style="color:#abb2bf">();</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#61afef">print</span><span style="color:#abb2bf">(ab);</span><span style="color:#7f848e;font-style:italic"> // CanAB</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#cf222e">template</span><span style="color:#24292f">&lt;</span><span style="color:#cf222e">typename</span><span style="color:#24292f"> </span><span style="color:#953800">T</span><span style="color:#24292f">&gt;</span></span>
<span class="line"><span style="color:#cf222e">concept</span><span style="color:#24292f"> CanA </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#cf222e">requires</span><span style="color:#24292f">(T t) { t.</span><span style="color:#8250df">a</span><span style="color:#24292f">(); };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">template</span><span style="color:#24292f">&lt;</span><span style="color:#cf222e">typename</span><span style="color:#24292f"> </span><span style="color:#953800">T</span><span style="color:#24292f">&gt;</span></span>
<span class="line"><span style="color:#cf222e">concept</span><span style="color:#24292f"> CanAB </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#cf222e">requires</span><span style="color:#24292f">(T t) { t.</span><span style="color:#8250df">b</span><span style="color:#24292f">(); } </span><span style="color:#cf222e">&amp;&amp;</span><span style="color:#24292f"> CanA</span><span style="color:#cf222e">&lt;</span><span style="color:#24292f">T</span><span style="color:#cf222e">&gt;</span><span style="color:#24292f">;</span></span>
<span class="line"><span style="color:#6e7781">// CanAB is more SPECIFIC than CanA</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">struct</span><span style="color:#24292f"> </span><span style="color:#953800">A</span><span style="color:#24292f"> { </span><span style="color:#cf222e">void</span><span style="color:#24292f"> </span><span style="color:#8250df">a</span><span style="color:#24292f">() {} };</span></span>
<span class="line"><span style="color:#cf222e">struct</span><span style="color:#24292f"> </span><span style="color:#953800">AB</span><span style="color:#24292f">: A { </span><span style="color:#cf222e">void</span><span style="color:#24292f"> </span><span style="color:#8250df">b</span><span style="color:#24292f">() {} };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">template</span><span style="color:#24292f">&lt;</span><span style="color:#cf222e">CanA</span><span style="color:#24292f"> </span><span style="color:#953800">T</span><span style="color:#24292f">&gt;</span></span>
<span class="line"><span style="color:#cf222e">void</span><span style="color:#24292f"> </span><span style="color:#8250df">print</span><span style="color:#24292f">(</span><span style="color:#953800">T</span><span style="color:#24292f"> </span><span style="color:#953800">t</span><span style="color:#24292f">) { </span><span style="color:#953800">std</span><span style="color:#24292f">::cout </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> </span><span style="color:#0a3069">"CanA"</span><span style="color:#24292f"> </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> </span><span style="color:#953800">std</span><span style="color:#24292f">::endl; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">template</span><span style="color:#24292f">&lt;</span><span style="color:#cf222e">CanAB</span><span style="color:#24292f"> </span><span style="color:#953800">T</span><span style="color:#24292f">&gt;</span></span>
<span class="line"><span style="color:#cf222e">void</span><span style="color:#24292f"> </span><span style="color:#8250df">print</span><span style="color:#24292f">(</span><span style="color:#953800">T</span><span style="color:#24292f"> </span><span style="color:#953800">t</span><span style="color:#24292f">) { </span><span style="color:#953800">std</span><span style="color:#24292f">::cout </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> </span><span style="color:#0a3069">"CanAB"</span><span style="color:#24292f"> </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> </span><span style="color:#953800">std</span><span style="color:#24292f">::endl; }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">int</span><span style="color:#24292f"> </span><span style="color:#8250df">main</span><span style="color:#24292f">() {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">auto</span><span style="color:#24292f"> ab </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#8250df">AB</span><span style="color:#24292f">();</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">print</span><span style="color:#24292f">(ab);</span><span style="color:#6e7781"> // CanAB</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span></code></pre></div></code></pre><p>ä½† Rust çš„ <code>trait</code> ä¸å…è®¸ã€‚</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#282c34"><code><span class="line"><span style="color:#c678dd">trait</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Common</span><span style="color:#abb2bf"> {}</span></span>
<span class="line"><span style="color:#c678dd">trait</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">CanA</span><span style="color:#abb2bf"> {}</span></span>
<span class="line"><span style="color:#c678dd">trait</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">CanB</span><span style="color:#abb2bf"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c678dd">impl</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">CanA</span><span style="color:#abb2bf">&gt; </span><span style="color:#e5c07b">Common</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">for</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">T</span><span style="color:#abb2bf"> {}</span></span>
<span class="line"><span style="color:#c678dd">impl</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">CanA</span><span style="color:#abb2bf"> + </span><span style="color:#e5c07b">CanB</span><span style="color:#abb2bf">&gt; </span><span style="color:#e5c07b">Common</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">for</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">T</span><span style="color:#abb2bf"> {}</span><span style="color:#7f848e;font-style:italic"> // E0119: Conflicting implementations</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#cf222e">trait</span><span style="color:#24292f"> </span><span style="color:#953800">Common</span><span style="color:#24292f"> {}</span></span>
<span class="line"><span style="color:#cf222e">trait</span><span style="color:#24292f"> </span><span style="color:#953800">CanA</span><span style="color:#24292f"> {}</span></span>
<span class="line"><span style="color:#cf222e">trait</span><span style="color:#24292f"> </span><span style="color:#953800">CanB</span><span style="color:#24292f"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">impl</span><span style="color:#24292f">&lt;</span><span style="color:#953800">T</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">CanA</span><span style="color:#24292f">&gt; </span><span style="color:#953800">Common</span><span style="color:#24292f"> </span><span style="color:#cf222e">for</span><span style="color:#24292f"> </span><span style="color:#953800">T</span><span style="color:#24292f"> {}</span></span>
<span class="line"><span style="color:#cf222e">impl</span><span style="color:#24292f">&lt;</span><span style="color:#953800">T</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">CanA</span><span style="color:#24292f"> </span><span style="color:#cf222e">+</span><span style="color:#24292f"> </span><span style="color:#953800">CanB</span><span style="color:#24292f">&gt; </span><span style="color:#953800">Common</span><span style="color:#24292f"> </span><span style="color:#cf222e">for</span><span style="color:#24292f"> </span><span style="color:#953800">T</span><span style="color:#24292f"> {}</span><span style="color:#6e7781"> // E0119: Conflicting implementations</span></span>
<span class="line"></span></code></pre></div></code></pre><p>å°½ç®¡å¯ä»¥ç”¨ <code>#![feature(specialization)]</code> å¯ç”¨ <a href="https://rust-lang.github.io/rfcs/1210-impl-specialization.html" target="_blank" rel="noopener">RFC #1210</a> çš„ç‰¹åŒ–ï¼Œä½†å®ƒæ˜¯éå¯é çš„ï¼ˆunsoundï¼‰ï¼Œå¯èƒ½å¼•å‘ UBã€‚è¿™ä¸ª RFC å·²ç»ä¸å†ç»§ç»­æ¨è¿›äº†ï¼Œå¯èƒ½è¿˜æ˜¯è¦ç­‰å¾…æ–°çš„ <code>trait</code> è§£æå¼•æ“ <code>chalk</code>ã€‚</p><h2 id="å¯å˜å‚æ•°æ³›å‹" tabindex="-1">å¯å˜å‚æ•°æ³›å‹</h2><p>ğŸ”´ æ— è§£</p><p>åœ¨ C++ ä¸­ï¼Œä½ å¯ä»¥ç”¨ <code>...</code> ä¸ºæ¨¡æ¿å’Œå‡½æ•°æŒ‡å®šå¯å˜çš„å‚æ•°åˆ—è¡¨ï¼ˆ<a href="https://en.cppreference.com/w/cpp/language/parameter_pack" target="_blank" rel="noopener">parameter pack</a>ï¼‰ï¼Œè¿™æ˜¯ä¸€ç§å¯å˜å‚æ•°æ³›å‹ï¼ˆvariadic genericsï¼‰ã€‚æ¯”å¦‚ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªæ¥å—ä¸å®šç±»å‹ï¼ˆåªéœ€æ»¡è¶³ç‰¹å®šçº¦æŸï¼‰ä¸”ä¸å®šé•¿åº¦çš„å‚æ•°çš„å‡½æ•°ï¼š</p><pre><code class="language-cpp"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#282c34"><code><span class="line"><span style="color:#c678dd">template</span><span style="color:#abb2bf">&lt;</span><span style="color:#c678dd">typename</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">&gt;</span></span>
<span class="line"><span style="color:#c678dd">concept</span><span style="color:#abb2bf"> printable </span><span style="color:#c678dd">=</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">requires</span><span style="color:#abb2bf">(T t) { std::cout </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> t; };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c678dd">template</span><span style="color:#abb2bf">&lt;</span><span style="color:#c678dd">printable</span><span style="color:#abb2bf">... </span><span style="color:#e5c07b">Ts</span><span style="color:#abb2bf">&gt;</span></span>
<span class="line"><span style="color:#c678dd">void</span><span style="color:#abb2bf"> </span><span style="color:#61afef">print_all</span><span style="color:#abb2bf">(</span><span style="color:#e5c07b">Ts</span><span style="color:#abb2bf">... </span><span style="color:#e06c75;font-style:italic">args</span><span style="color:#abb2bf">) {</span></span>
<span class="line"><span style="color:#abb2bf">    ((std::cout </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> args </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> </span><span style="color:#98c379">' '</span><span style="color:#abb2bf">), ...) </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> std::endl;</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c678dd">int</span><span style="color:#abb2bf"> </span><span style="color:#61afef">main</span><span style="color:#abb2bf">() {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#61afef">print_all</span><span style="color:#abb2bf">(</span><span style="color:#d19a66">1</span><span style="color:#abb2bf">, </span><span style="color:#d19a66">2.3</span><span style="color:#abb2bf">, </span><span style="color:#98c379">'a'</span><span style="color:#abb2bf">, </span><span style="color:#98c379">"string"</span><span style="color:#abb2bf">);</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#cf222e">template</span><span style="color:#24292f">&lt;</span><span style="color:#cf222e">typename</span><span style="color:#24292f"> </span><span style="color:#953800">T</span><span style="color:#24292f">&gt;</span></span>
<span class="line"><span style="color:#cf222e">concept</span><span style="color:#24292f"> printable </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#cf222e">requires</span><span style="color:#24292f">(T t) { </span><span style="color:#953800">std</span><span style="color:#24292f">::cout </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> t; };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">template</span><span style="color:#24292f">&lt;</span><span style="color:#cf222e">printable</span><span style="color:#24292f">... </span><span style="color:#953800">Ts</span><span style="color:#24292f">&gt;</span></span>
<span class="line"><span style="color:#cf222e">void</span><span style="color:#24292f"> </span><span style="color:#8250df">print_all</span><span style="color:#24292f">(</span><span style="color:#953800">Ts</span><span style="color:#24292f">... </span><span style="color:#953800">args</span><span style="color:#24292f">) {</span></span>
<span class="line"><span style="color:#24292f">    ((</span><span style="color:#953800">std</span><span style="color:#24292f">::cout </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> args </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> </span><span style="color:#0a3069">' '</span><span style="color:#24292f">), ...) </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> </span><span style="color:#953800">std</span><span style="color:#24292f">::endl;</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">int</span><span style="color:#24292f"> </span><span style="color:#8250df">main</span><span style="color:#24292f">() {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">print_all</span><span style="color:#24292f">(</span><span style="color:#0550ae">1</span><span style="color:#24292f">, </span><span style="color:#0550ae">2.3</span><span style="color:#24292f">, </span><span style="color:#0a3069">'a'</span><span style="color:#24292f">, </span><span style="color:#0a3069">"string"</span><span style="color:#24292f">);</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span></code></pre></div></code></pre><p>ä½†åœ¨ Rust é‡Œåšä¸åˆ°ï¼Œåªèƒ½ç”¨å®ï¼Œä½†å®ä¸å¯èƒ½åƒæ³›å‹ä¸€æ ·å±•å¼€å‡ºæ— é™å¤šä¸ªå£°æ˜ã€‚æ‰€ä»¥åœ¨æ ‡å‡†åº“é‡Œâ€¦â€¦</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#282c34"><code><span class="line"><span style="color:#c678dd">impl</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">T0</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">T1</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">T2</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">T3</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">T4</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">T5</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">T6</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">T7</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">T8</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">T9</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">T10</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">T11</span><span style="color:#abb2bf">&gt; </span><span style="color:#e5c07b">Debug</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">for</span><span style="color:#abb2bf"> (</span><span style="color:#e5c07b">T0</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">T1</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">T2</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">T3</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">T4</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">T5</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">T6</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">T7</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">T8</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">T9</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">T10</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">T11</span><span style="color:#abb2bf">)</span></span>
<span class="line"><span style="color:#c678dd">where</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e5c07b">T0</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">Debug</span><span style="color:#abb2bf">,</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e5c07b">T1</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">Debug</span><span style="color:#abb2bf">,</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e5c07b">T2</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">Debug</span><span style="color:#abb2bf">,</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e5c07b">T3</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">Debug</span><span style="color:#abb2bf">,</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e5c07b">T4</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">Debug</span><span style="color:#abb2bf">,</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e5c07b">T5</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">Debug</span><span style="color:#abb2bf">,</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e5c07b">T6</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">Debug</span><span style="color:#abb2bf">,</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e5c07b">T7</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">Debug</span><span style="color:#abb2bf">,</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e5c07b">T8</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">Debug</span><span style="color:#abb2bf">,</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e5c07b">T9</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">Debug</span><span style="color:#abb2bf">,</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e5c07b">T10</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">Debug</span><span style="color:#abb2bf">,</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e5c07b">T11</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">Debug</span><span style="color:#abb2bf"> + ?</span><span style="color:#e5c07b">Sized</span><span style="color:#abb2bf">,</span><span style="color:#7f848e;font-style:italic"> // OMG</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#cf222e">impl</span><span style="color:#24292f">&lt;</span><span style="color:#953800">T0</span><span style="color:#24292f">, </span><span style="color:#953800">T1</span><span style="color:#24292f">, </span><span style="color:#953800">T2</span><span style="color:#24292f">, </span><span style="color:#953800">T3</span><span style="color:#24292f">, </span><span style="color:#953800">T4</span><span style="color:#24292f">, </span><span style="color:#953800">T5</span><span style="color:#24292f">, </span><span style="color:#953800">T6</span><span style="color:#24292f">, </span><span style="color:#953800">T7</span><span style="color:#24292f">, </span><span style="color:#953800">T8</span><span style="color:#24292f">, </span><span style="color:#953800">T9</span><span style="color:#24292f">, </span><span style="color:#953800">T10</span><span style="color:#24292f">, </span><span style="color:#953800">T11</span><span style="color:#24292f">&gt; </span><span style="color:#953800">Debug</span><span style="color:#24292f"> </span><span style="color:#cf222e">for</span><span style="color:#24292f"> (</span><span style="color:#953800">T0</span><span style="color:#24292f">, </span><span style="color:#953800">T1</span><span style="color:#24292f">, </span><span style="color:#953800">T2</span><span style="color:#24292f">, </span><span style="color:#953800">T3</span><span style="color:#24292f">, </span><span style="color:#953800">T4</span><span style="color:#24292f">, </span><span style="color:#953800">T5</span><span style="color:#24292f">, </span><span style="color:#953800">T6</span><span style="color:#24292f">, </span><span style="color:#953800">T7</span><span style="color:#24292f">, </span><span style="color:#953800">T8</span><span style="color:#24292f">, </span><span style="color:#953800">T9</span><span style="color:#24292f">, </span><span style="color:#953800">T10</span><span style="color:#24292f">, </span><span style="color:#953800">T11</span><span style="color:#24292f">)</span></span>
<span class="line"><span style="color:#cf222e">where</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">T0</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">Debug</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">T1</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">Debug</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">T2</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">Debug</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">T3</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">Debug</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">T4</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">Debug</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">T5</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">Debug</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">T6</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">Debug</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">T7</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">Debug</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">T8</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">Debug</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">T9</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">Debug</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">T10</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">Debug</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">T11</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">Debug</span><span style="color:#24292f"> </span><span style="color:#cf222e">+</span><span style="color:#24292f"> </span><span style="color:#cf222e">?</span><span style="color:#953800">Sized</span><span style="color:#24292f">,</span><span style="color:#6e7781"> // OMG</span></span>
<span class="line"></span></code></pre></div></code></pre><p>åªæœ‰åŠ›æ°”æšä¸¾åˆ° 12 ä¸ª ğŸ¤¯ã€‚å…¶ä»–æ—¶å€™ï¼Œä½ åªèƒ½è‡ªå·±å®šä¹‰ <code>struct(...)</code> å¹¶ä¸”ç”¨ <code>#[derive]</code> æ¼”ç»ï¼Œæˆ–è€…æ‰‹å†™ä¸€ä¸ªå®ç°ã€‚åœ¨å¸¸é‡æ³›å‹ç¨³å®šå‰ï¼Œæ•°ç»„ä¹Ÿæ˜¯ç±»ä¼¼çš„ä¸‹åœºï¼ˆä½†æ›´æƒ¨ï¼Œæšä¸¾äº† 32 ä¸ªï¼‰ã€‚æ—¢ç„¶å¸¸é‡æ³›å‹ç»è¿‡äº”å¹´é•¿è·‘ç»ˆäºç¨³å®šäº†ï¼Œé‚£ä¹ˆå¯å˜å‚æ•°æ³›å‹æ˜¯ä¸æ˜¯æœªæ¥å¯æœŸï¼Ÿéä¹Ÿï¼Œå®ƒçš„ <a href="https://github.com/rust-lang/rfcs/issues/376" target="_blank" rel="noopener">RFC #376</a> å·²ç»å¡åœ¨è‰æ¡ˆé˜¶æ®µäº”å¹´äº†ã€‚</p><h2 id="default-å’Œç©ºæ•°ç»„" tabindex="-1"><code>Default</code> å’Œç©ºæ•°ç»„</h2><p>ğŸŸ  æç½®</p><p>æ—¢ç„¶å¸¸é‡æ³›å‹ç¨³å®šäº†ï¼Œä¸ºä»€ä¹ˆä¸ºæ•°ç»„å®ç°çš„ <code>Default</code> è¿˜æ˜¯é•¿åº¦ä¸º 32 çš„æšä¸¾å‘¢ï¼Ÿå› ä¸ºï¼š</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#282c34"><code><span class="line"><span style="color:#c678dd">impl</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">&gt; </span><span style="color:#e5c07b">Default</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">for</span><span style="color:#abb2bf"> [</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">; </span><span style="color:#d19a66">0</span><span style="color:#abb2bf">]</span></span>
<span class="line"><span style="color:#c678dd">impl</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">Default</span><span style="color:#abb2bf">, </span><span style="color:#c678dd">const</span><span style="color:#abb2bf"> </span><span style="color:#d19a66">N</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">usize</span><span style="color:#abb2bf">&gt; </span><span style="color:#e5c07b">Default</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">for</span><span style="color:#abb2bf"> [</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">; </span><span style="color:#e5c07b">N</span><span style="color:#abb2bf">]</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#cf222e">impl</span><span style="color:#24292f">&lt;</span><span style="color:#953800">T</span><span style="color:#24292f">&gt; </span><span style="color:#953800">Default</span><span style="color:#24292f"> </span><span style="color:#cf222e">for</span><span style="color:#24292f"> [</span><span style="color:#953800">T</span><span style="color:#24292f">; </span><span style="color:#0550ae">0</span><span style="color:#24292f">]</span></span>
<span class="line"><span style="color:#cf222e">impl</span><span style="color:#24292f">&lt;</span><span style="color:#953800">T</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">Default</span><span style="color:#24292f">, </span><span style="color:#cf222e">const</span><span style="color:#24292f"> </span><span style="color:#0550ae">N</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">usize</span><span style="color:#24292f">&gt; </span><span style="color:#953800">Default</span><span style="color:#24292f"> </span><span style="color:#cf222e">for</span><span style="color:#24292f"> [</span><span style="color:#953800">T</span><span style="color:#24292f">; </span><span style="color:#953800">N</span><span style="color:#24292f">]</span></span>
<span class="line"></span></code></pre></div></code></pre><p>ç©ºæ•°ç»„çš„å…ƒç´ ä¸æ˜¯ <code>Default</code> ä¹Ÿæ²¡é—®é¢˜ï¼æ‰€ä»¥ä»ç„¶éœ€è¦ç‰¹åŒ–æ‰èƒ½è§£å†³â€¦â€¦</p><h2 id="box-å’Œ-box" tabindex="-1"><code>box</code> å’Œ <code>Box</code></h2><p>ğŸ”µ ä¸ç¨³å®š</p><p>Rust çš„å †ä¸Šåˆ†é…åŸæœ¬ç”±ç‰¹æ®Šçš„è¯­æ³• <a href="https://rust-lang.github.io/rfcs/0059-remove-tilde.html" target="_blank" rel="noopener"><code>~</code></a> å®ç°ï¼Œä½†åæ¥è¢«åŒ…è£…åˆ°äº† <code>Box</code> ç»“æ„ä½“ï¼Œå†…éƒ¨å®ç°ä»ä½¿ç”¨ç‰¹æ®Šè¯­æ³• <a href="https://doc.rust-lang.org/unstable-book/language-features/box-syntax.html" target="_blank" rel="noopener"><code>box</code></a>ã€‚<a href="https://course.rs/advance/smart-pointer/box.html" target="_blank" rel="noopener">æŸæ•™ç¨‹</a>ä¼šè¯´ï¼Œä½¿ç”¨äº† <code>Box::new()</code> å°±èƒ½æŠŠå·¨å¤§çš„ä¸œè¥¿æ‰”åˆ°å †ä¸Šäº†ï¼Œä½†â€¦â€¦</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#282c34"><code><span class="line"><span style="color:#abb2bf">#[test]</span></span>
<span class="line"><span style="color:#c678dd">fn</span><span style="color:#abb2bf"> </span><span style="color:#61afef">test</span><span style="color:#abb2bf">() {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">large</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Box</span><span style="color:#abb2bf">::</span><span style="color:#61afef">new</span><span style="color:#abb2bf">([</span><span style="color:#d19a66">0</span><span style="color:#abb2bf">; </span><span style="color:#d19a66">1000000</span><span style="color:#abb2bf">]);</span><span style="color:#7f848e;font-style:italic"> // fatal runtime error: stack overflow</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#24292f">#[test]</span></span>
<span class="line"><span style="color:#cf222e">fn</span><span style="color:#24292f"> </span><span style="color:#8250df">test</span><span style="color:#24292f">() {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> large </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">Box</span><span style="color:#cf222e">::</span><span style="color:#8250df">new</span><span style="color:#24292f">([</span><span style="color:#0550ae">0</span><span style="color:#24292f">; </span><span style="color:#0550ae">1000000</span><span style="color:#24292f">]);</span><span style="color:#6e7781"> // fatal runtime error: stack overflow</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span></code></pre></div></code></pre><p>å¹¶ä¸æ˜¯è¿™æ ·ã€‚Rust æ²¡æœ‰åƒ C++ ä¸€æ ·çš„å¤åˆ¶ï¼ˆæˆ–ç§»åŠ¨ï¼‰æ“¦é™¤ä¿è¯ï¼ˆcopy ellisionï¼‰ï¼Œè‡ªä» C++ 17 å¼€å§‹ï¼ŒåŒ…æ‹¬å­—é¢é‡åœ¨å†…çš„çº¯å€¼ï¼ˆprvalueï¼‰åœ¨ç”¨æ¥åˆå§‹åŒ–å˜é‡æ—¶ä¿è¯ä¸ä¼šè°ƒç”¨å¤åˆ¶æ„é€ å‡½æ•°â€”â€”ä½† Rust æ ¹æœ¬å°±<em>æ²¡æœ‰</em>æ„é€ å‡½æ•°ï¼Œ<code>new</code> ä¸è¿‡æ˜¯ä¸€ä¸ªæ™®æ™®é€šé€šçš„å…³è”æ–¹æ³•ã€‚æ‰€ä»¥ï¼Œå¦‚æœæ²¡æœ‰ä¼˜åŒ–ï¼Œå®å‚ä¼šè¢«åˆ†é…åˆ°æ ˆä¸Šï¼Œå†ç§»åŠ¨åˆ°å †ä¸Šã€‚å› æ­¤æ ˆè¿˜æ˜¯çˆ†äº†ã€‚è‹¥æƒ³è¦ä¸€å‘ä¸Šå †ï¼Œä½ å¾—æ‰“å¼€ Nightly ç”¨ <code>box</code> è¯­æ³•ï¼Œ<s>æˆ–è€…å¼€ <code>unsafe</code> æ‰‹åŠ¨æ‰”è¿› BSS æ®µ</s>ã€‚</p><h2 id="maybeuninit" tabindex="-1"><code>MaybeUninit</code></h2><p>ğŸŸ¢ è§£å†³</p><p>Rust ç¼–è¯‘å™¨æ‰§è¡Œä¼˜åŒ–æ—¶æ°¸è¿œå‡å®š<strong>å€¼æ˜¯éç©ºçš„</strong>ã€‚æ‰€ä»¥ï¼Œç»“æ„ä½“å’Œæšä¸¾çš„å†…å­˜å¸ƒå±€å¯èƒ½æŒ‰ç…§ä¸å­˜åœ¨ç©ºå€¼çš„æƒ…å†µè¢«ä¼˜åŒ–ã€‚ä½†å¦‚æœç”¨ <code>unsafe</code> ç­‰æ‰‹æ®µäº§ç”Ÿäº†ç©ºå€¼ï¼Œåˆ™å¯èƒ½ç”±äºç©ºå€¼çš„å†…å­˜è¡¨ç¤ºå’Œåˆæ³•å€¼å†²çªï¼Œå¯¼è‡´ UBã€‚å› æ­¤ï¼ŒRust 1.36 å¢åŠ äº†ä¸€ä¸ªè”åˆä½“ <code>MaybeUninit</code> æ˜¾å¼åœ°å…³é—­è¿™ç§å†…å­˜ä¼˜åŒ–ã€‚</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#282c34"><code><span class="line"><span style="color:#61afef">assert_eq!</span><span style="color:#abb2bf">(</span><span style="color:#61afef">size_of</span><span style="color:#abb2bf">::&lt;</span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">bool</span><span style="color:#abb2bf">&gt;&gt;(), </span><span style="color:#d19a66">1</span><span style="color:#abb2bf">);</span></span>
<span class="line"><span style="color:#61afef">assert_eq!</span><span style="color:#abb2bf">(</span><span style="color:#61afef">size_of</span><span style="color:#abb2bf">::&lt;</span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">MaybeUninit</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">bool</span><span style="color:#abb2bf">&gt;&gt;&gt;(), </span><span style="color:#d19a66">2</span><span style="color:#abb2bf">);</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#8250df">assert_eq!</span><span style="color:#24292f">(</span><span style="color:#8250df">size_of</span><span style="color:#cf222e">::</span><span style="color:#24292f">&lt;</span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">bool</span><span style="color:#24292f">&gt;&gt;(), </span><span style="color:#0550ae">1</span><span style="color:#24292f">);</span></span>
<span class="line"><span style="color:#8250df">assert_eq!</span><span style="color:#24292f">(</span><span style="color:#8250df">size_of</span><span style="color:#cf222e">::</span><span style="color:#24292f">&lt;</span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">MaybeUninit</span><span style="color:#24292f">&lt;</span><span style="color:#953800">bool</span><span style="color:#24292f">&gt;&gt;&gt;(), </span><span style="color:#0550ae">2</span><span style="color:#24292f">);</span></span>
<span class="line"></span></code></pre></div></code></pre><h2 id="å†…å­˜æ³„æ¼æ˜¯å®‰å…¨çš„" tabindex="-1">â€œå†…å­˜æ³„æ¼æ˜¯å®‰å…¨çš„â€</h2><p>âš« ç‰¹æ€§</p><p>Rust æœ€åˆè®¤ä¸º <code>drop</code> è§£æ„å¯ä»¥ä¿è¯è¢«è°ƒç”¨ï¼Œæ‰€ä»¥ Rust çš„å®‰å…¨ä¿è¯åŒ…æ‹¬ä¸ä¼šå‘ç”Ÿå†…å­˜æ³„éœ²ã€‚ä½†ä»–ä»¬å¿˜è®°äº†å¯ä»¥ç”¨å¼•ç”¨è®¡æ•°æŒ‡é’ˆ <code>Rc</code> å’Œå†…éƒ¨å¯å˜ <code>RefCell</code> æ‹‰ä¸€ä¸ª<em>ç¯</em>ã€‚</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#282c34"><code><span class="line"><span style="color:#c678dd">fn</span><span style="color:#abb2bf"> </span><span style="color:#61afef">safe_forget</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">&gt;(</span><span style="color:#e06c75">data</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">) {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">use</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">std</span><span style="color:#abb2bf">::</span><span style="color:#e5c07b">rc</span><span style="color:#abb2bf">::</span><span style="color:#e5c07b">Rc</span><span style="color:#abb2bf">;</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">use</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">std</span><span style="color:#abb2bf">::</span><span style="color:#e5c07b">cell</span><span style="color:#abb2bf">::</span><span style="color:#e5c07b">RefCell</span><span style="color:#abb2bf">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">struct</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Leak</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">&gt; {</span></span>
<span class="line"><span style="color:#abb2bf">        </span><span style="color:#e06c75">cycle</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">RefCell</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">Rc</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">Rc</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">Leak</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">&gt;&gt;&gt;&gt;&gt;,</span></span>
<span class="line"><span style="color:#abb2bf">        </span><span style="color:#e06c75">data</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">,</span></span>
<span class="line"><span style="color:#abb2bf">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">e</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Rc</span><span style="color:#abb2bf">::</span><span style="color:#61afef">new</span><span style="color:#abb2bf">(</span><span style="color:#e5c07b">Leak</span><span style="color:#abb2bf"> {</span></span>
<span class="line"><span style="color:#abb2bf">        </span><span style="color:#e06c75">cycle</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">RefCell</span><span style="color:#abb2bf">::</span><span style="color:#61afef">new</span><span style="color:#abb2bf">(</span><span style="color:#e5c07b">None</span><span style="color:#abb2bf">),</span></span>
<span class="line"><span style="color:#abb2bf">        </span><span style="color:#e06c75">data</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">data</span><span style="color:#abb2bf">,</span></span>
<span class="line"><span style="color:#abb2bf">    });</span></span>
<span class="line"><span style="color:#abb2bf">    *</span><span style="color:#e06c75">e</span><span style="color:#abb2bf">.cycle.</span><span style="color:#61afef">borrow_mut</span><span style="color:#abb2bf">() </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Some</span><span style="color:#abb2bf">(</span><span style="color:#e5c07b">Rc</span><span style="color:#abb2bf">::</span><span style="color:#61afef">new</span><span style="color:#abb2bf">(</span><span style="color:#e06c75">e</span><span style="color:#abb2bf">.</span><span style="color:#61afef">clone</span><span style="color:#abb2bf">()));</span><span style="color:#7f848e;font-style:italic"> // Create a cycle</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#cf222e">fn</span><span style="color:#24292f"> </span><span style="color:#8250df">safe_forget</span><span style="color:#24292f">&lt;</span><span style="color:#953800">T</span><span style="color:#24292f">&gt;(data</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">T</span><span style="color:#24292f">) {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">use</span><span style="color:#24292f"> </span><span style="color:#953800">std</span><span style="color:#cf222e">::</span><span style="color:#953800">rc</span><span style="color:#cf222e">::</span><span style="color:#953800">Rc</span><span style="color:#24292f">;</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">use</span><span style="color:#24292f"> </span><span style="color:#953800">std</span><span style="color:#cf222e">::</span><span style="color:#953800">cell</span><span style="color:#cf222e">::</span><span style="color:#953800">RefCell</span><span style="color:#24292f">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">struct</span><span style="color:#24292f"> </span><span style="color:#953800">Leak</span><span style="color:#24292f">&lt;</span><span style="color:#953800">T</span><span style="color:#24292f">&gt; {</span></span>
<span class="line"><span style="color:#24292f">        cycle</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">RefCell</span><span style="color:#24292f">&lt;</span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">Rc</span><span style="color:#24292f">&lt;</span><span style="color:#953800">Rc</span><span style="color:#24292f">&lt;</span><span style="color:#953800">Leak</span><span style="color:#24292f">&lt;</span><span style="color:#953800">T</span><span style="color:#24292f">&gt;&gt;&gt;&gt;&gt;,</span></span>
<span class="line"><span style="color:#24292f">        data</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">T</span><span style="color:#24292f">,</span></span>
<span class="line"><span style="color:#24292f">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> e </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">Rc</span><span style="color:#cf222e">::</span><span style="color:#8250df">new</span><span style="color:#24292f">(</span><span style="color:#953800">Leak</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">        cycle</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">RefCell</span><span style="color:#cf222e">::</span><span style="color:#8250df">new</span><span style="color:#24292f">(</span><span style="color:#953800">None</span><span style="color:#24292f">),</span></span>
<span class="line"><span style="color:#24292f">        data</span><span style="color:#cf222e">:</span><span style="color:#24292f"> data,</span></span>
<span class="line"><span style="color:#24292f">    });</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">*</span><span style="color:#24292f">e</span><span style="color:#cf222e">.</span><span style="color:#24292f">cycle</span><span style="color:#cf222e">.</span><span style="color:#8250df">borrow_mut</span><span style="color:#24292f">() </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">Some</span><span style="color:#24292f">(</span><span style="color:#953800">Rc</span><span style="color:#cf222e">::</span><span style="color:#8250df">new</span><span style="color:#24292f">(e</span><span style="color:#cf222e">.</span><span style="color:#8250df">clone</span><span style="color:#24292f">()));</span><span style="color:#6e7781"> // Create a cycle</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span></code></pre></div></code></pre><p>è¿™ä¸€åœ¨ <a href="https://github.com/rust-lang/rust/issues/24292" target="_blank" rel="noopener">std::thread::JoinGuard (and scoped) are unsound because of reference cycles Â· Issue #24292 Â· rust-lang/rust (github.com)</a> çˆ†å‡ºçš„è®¾è®¡ç¾éš¾è¢«ç§°ä½œâ€œå¤©æœºæ³„éœ²â€ï¼ˆLeakpocalypseï¼‰ï¼Œæœ€ç»ˆï¼Œå†…å­˜æ³„éœ²â€”â€”ä»¥åŠæ‰‹åŠ¨æ³„éœ²å†…å­˜ <code>mem::forget</code> éƒ½æˆäº†å®‰å…¨çš„ï¼Œ<code>Rc</code> å¢åŠ äº†æº¢å‡ºæ£€æŸ¥ï¼Œè¿­ä»£å™¨è°ƒç”¨ <code>drain</code> å¯èƒ½å¯¼è‡´å†…å­˜æ³„éœ²ï¼ŒåŒæ—¶ä¾èµ– <code>drop</code> ä¿è¯ä½œä¸ºçº¿ç¨‹å®ˆå«çš„ <code>thread::scoped</code> ä¹Ÿè¢«ç§»é™¤ã€‚</p><p>ä¸è¿‡ï¼Œæœ€ç»ˆ <a href="https://rust-lang.github.io/rfcs/3151-scoped-threads.html" target="_blank" rel="noopener">RFC #3151</a> å†³å®šæŠŠ <code>crossbeam</code> åº“ä¸­ä½¿ç”¨é—­åŒ…çš„å¸¦ä½œç”¨åŸŸçº¿ç¨‹åŠ å›æ ‡å‡†åº“ã€‚</p><h2 id="turbofish" tabindex="-1">Turbofish</h2><p>âš« ç‰¹æ€§</p><p>Rust å¸Œæœ›èƒ½åƒ C++ ä¸€æ ·åœ¨æ³›å‹å‡½æ•°è°ƒç”¨æ—¶ä½¿ç”¨ <code>id&lt;T&gt;(...)</code> è¿™æ ·çš„æ–‡æ³•è€Œä¸æ˜¯ <code>id::&lt;T&gt;()</code>ã€‚ä½†ï¼š</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#282c34"><code><span class="line"><span style="color:#c678dd">let</span><span style="color:#abb2bf"> (</span><span style="color:#e06c75">the</span><span style="color:#abb2bf">, </span><span style="color:#e06c75">guardian</span><span style="color:#abb2bf">, </span><span style="color:#e06c75">stands</span><span style="color:#abb2bf">, </span><span style="color:#e06c75">resolute</span><span style="color:#abb2bf">) </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> (</span><span style="color:#98c379">"the"</span><span style="color:#abb2bf">, </span><span style="color:#98c379">"Turbofish"</span><span style="color:#abb2bf">, </span><span style="color:#98c379">"remains"</span><span style="color:#abb2bf">, </span><span style="color:#98c379">"undefeated"</span><span style="color:#abb2bf">);</span></span>
<span class="line"><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_</span><span style="color:#abb2bf">: (</span><span style="color:#e5c07b">bool</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">bool</span><span style="color:#abb2bf">) </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> (</span><span style="color:#e06c75">the</span><span style="color:#abb2bf">&lt;</span><span style="color:#e06c75">guardian</span><span style="color:#abb2bf">, </span><span style="color:#e06c75">stands</span><span style="color:#abb2bf">&gt;(</span><span style="color:#e06c75">resolute</span><span style="color:#abb2bf">));</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#cf222e">let</span><span style="color:#24292f"> (the, guardian, stands, resolute) </span><span style="color:#cf222e">=</span><span style="color:#24292f"> (</span><span style="color:#0a3069">"the"</span><span style="color:#24292f">, </span><span style="color:#0a3069">"Turbofish"</span><span style="color:#24292f">, </span><span style="color:#0a3069">"remains"</span><span style="color:#24292f">, </span><span style="color:#0a3069">"undefeated"</span><span style="color:#24292f">);</span></span>
<span class="line"><span style="color:#cf222e">let</span><span style="color:#24292f"> _</span><span style="color:#cf222e">:</span><span style="color:#24292f"> (</span><span style="color:#953800">bool</span><span style="color:#24292f">, </span><span style="color:#953800">bool</span><span style="color:#24292f">) </span><span style="color:#cf222e">=</span><span style="color:#24292f"> (the&lt;guardian, stands&gt;(resolute));</span></span>
<span class="line"></span></code></pre></div></code></pre><p>æ‰“ç ´äº†è¿™ä¸€å¹»æƒ³ã€‚ä¸ºè¿™ä¸ªè¯­æ³•èµå Turbofish çš„ Rust å›¢é˜Ÿæˆå‘˜ Anna Harren åæ¥å› ç—…å»ä¸–ï¼Œ<a href="https://turbo.fish/" target="_blank" rel="noopener">Turbofish</a> è¿™ä¸ªè¯­æ³•å’Œåå­—ä¹Ÿæˆä¸ºäº†å¥¹çš„çºªå¿µï¼Œç•™åœ¨äº† Rust é‡Œã€‚</p><p>è¿™åœºè®²åº§å¤§æ¦‚æ˜¯æˆ‘ç§è‰ Rust çš„èµ·ç‚¹ï¼Œä»Šå¤©æœ‰å¹¸è§åˆ°äº†ä¸»è®²æœ¬å°Šï¼Œäºæ˜¯å†³å®šæŠŠè¿™ç¯‡å¹²è´§å†å›é¡¾äº†ä¸€éã€‚ä¸»è®²æœ€åè¯´ï¼š</p><blockquote><p>è™½ç„¶ Rust æœ‰è¿™æ ·é‚£æ ·çš„é—®é¢˜ï¼Œä½†æ˜¯å’Œåˆ«çš„è¯­è¨€æ¯”è¿˜æ˜¯å¾ˆå¥½çš„ï¼</p></blockquote><p>æœ€åï¼Œæˆ‘ä»¬æƒ³è¯´ï¼š</p><blockquote><p>C++ æ˜å¤©æ›´å¥½ã€‚</p></blockquote></div></article></article></main></main><!----><!--]--></div><script>window.__INITIAL_STATE__='{"pinia":{}}'</script><script>!function(){var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,a=localStorage.getItem("color-scheme")||"auto",t=(document.documentElement.className="dark"===a||t&&"light"!==a?"dark":"",localStorage.getItem("typesetting::accent_color"));if(t){a=JSON.parse(t),t=Object.entries(a).map(e=>`--accent-${e[0]}: ${e[1]};`).join("\n");let e=document.createElement("style");e.type="text/css",e.innerText=`:root{${t}}`,document.head.appendChild(e)}}()</script><link rel="stylesheet" href="/assets/app.f386ae20.css"></body></html>